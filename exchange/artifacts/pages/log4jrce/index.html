<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.91.0">
<meta name=description content>
<link rel=icon href=/images/favicon.png type=image/png>
<title>Generic.Detection.log4jRCE :: Velociraptor - Digging deeper!</title>
<link href=/css/nucleus.css?1640222966 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1640222966 rel=stylesheet>
<link href=/css/featherlight.min.css?1640222966 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1640222966 rel=stylesheet>
<link href=/css/auto-complete.css?1640222966 rel=stylesheet>
<link href=/css/theme.css?1640222966 rel=stylesheet>
<link href=/css/tabs.css?1640222966 rel=stylesheet>
<link href=/css/hugo-theme.css?1640222966 rel=stylesheet>
<link href=/css/theme-mine.css?1640222966 rel=stylesheet>
<link href=/css/dark.css?1640222966 rel=stylesheet><link href=/css/syntax.css?1640222966 rel=stylesheet><link href=/css/light.css?1640222966 rel=stylesheet><link href=/css/hljs.css?1640222966 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1640222966 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1640222966></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYH72LMYCS',{anonymize_ip:!1})}</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYH72LMYCS','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script></script>
</head>
<body data-url=/exchange/artifacts/pages/log4jrce/>
<nav id=sidebar><div id=header-wrapper>
<div id=header>
<script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script>
<div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()>
<i class="fas fa-moon"></i>
</div>
<div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()>
<i class="fas fa-sun"></i>
</div>
<a href=https://docs.velociraptor.app/>
<img src=https://docs.velociraptor.app//images/logo.svg>
</a>
</div>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/announcements/2021-artifact-contest/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2021-artifact-contest/>2021 Contest</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a>
</div>
</li>
</ul>
</li>
</ul>
</li><hr>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item parent haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a>
</div>
</li>
</ul>
<hr>
<section id=shortcuts>
<h3></h3>
<ul>
<li>
<a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a>
</li>
<li>
<a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a>
</li>
<li>
<a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a>
</li>
</ul>
</section>
<section id=footer>
<div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7>
<br> <i class="fas fa-copyright"></i> 2021
</div>
</section>
</div>
</nav>
<script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=top-github-link>
<a class=github-link title="Edit this page" href=https://github.com/Velocidex/velociraptor-docs/edit/master/content/exchange/artifacts/log4jRCE.yaml target=blank>
<i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span>
</a>
</div>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
Generic.Detection.log4jRCE
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents></nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
Generic.Detection.log4jRCE
</h1>
<p>Detection for exploitation attempts against log4j RCE
vulnerability CVE-2021-44228.</p>
<p>By default this artifact will search for linux path glob: /var/logs/**</p>
<p>For Windows hosts please change the target path.<br>
Some examples of path glob may include:</p>
<ul>
<li>Specific binary: <code>/var/logs/log.gz</code></li>
<li>Wildcards: <code>/var/log/*.gz</code></li>
<li>More wildcards: <code>/var/www/**/*.log</code></li>
<li>Multiple extentions: <code>/var/log/**/*\.{log,gz}</code></li>
<li>Windows: <code>C:/Logs/**/*.{gz,log}</code> or <code>**/*.{gz,log}</code></li>
</ul>
<p>NOTE: this artifact runs the glob plugin with the nosymlink switch turned on.
This will NOT follow any symlinks and may cause unexpected results if
unknowingly targeting a folder with symlinks.</p>
<pre><code class=language-yaml>name: Generic.Detection.log4jRCE
author: Matt Green - @mgreen27
description: |
  Detection for exploitation attempts against log4j RCE 
  vulnerability CVE-2021-44228.
  
  By default this artifact will search for linux path glob: /var/logs/**
  
  For Windows hosts please change the target path.  
  Some examples of path glob may include:  

  * Specific binary: `/var/logs/log.gz` 
  * Wildcards: `/var/log/*.gz` 
  * More wildcards: `/var/www/**/*.log`  
  * Multiple extentions: `/var/log/**/*\.{log,gz}`  
  * Windows: `C:/Logs/**/*.{gz,log}` or `**/*.{gz,log}`      
    
  NOTE: this artifact runs the glob plugin with the nosymlink switch turned on. 
  This will NOT follow any symlinks and may cause unexpected results if 
  unknowingly targeting a folder with symlinks.

reference:
  - https://github.com/Neo23x0/signature-base/blob/master/yara/expl_log4j_cve_2021_44228.yar
  
type: CLIENT
parameters:
  - name: PathGlob
    description: Only file names that match this glob will be scanned.
    default: /var/log/**
  - name: SizeMax
    description: maximum size of target file.
  - name: SizeMin
    description: minimum size of target file.
  - name: UploadHits
    type: bool
  - name: DateAfter
    type: timestamp
    description: &quot;search for events after this date. YYYY-MM-DDTmm:hh:ssZ&quot;
  - name: DateBefore
    type: timestamp
    description: &quot;search for events before this date. YYYY-MM-DDTmm:hh:ssZ&quot;
  - name: YaraUrl
    description: If configured will attempt to download Yara rules form Url
    default:
  - name: ShortHandYara
    description: Second option Yara choice is a Velociraptor shorthand Yara rule
    default:
  - name: YaraRule
    description: Final Yara option and the default if no other options provided.
    default: |
        rule EXPL_Log4j_CallBackDomain_IOCs_Dec21_1 {
           meta:
              description = &quot;Detects IOCs found in Log4Shell incidents that indicate exploitation attempts of CVE-2021-44228&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://gist.github.com/superducktoes/9b742f7b44c71b4a0d19790228ce85d8&quot;
              date = &quot;2021-12-12&quot;
              score = 60
           strings:
              $xr1  = /\b(ldap|rmi):\/\/([a-z0-9\.]{1,16}\.bingsearchlib\.com|[a-z0-9\.]{1,40}\.interact\.sh|[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}):[0-9]{2,5}\/([aZ]|ua|Exploit|callback|[0-9]{10}|http443useragent|http80useragent)\b/
           condition:
              1 of them
        }

        rule EXPL_JNDI_Exploit_Patterns_Dec21_1 {
           meta:
              description = &quot;Detects JNDI Exploit Kit patterns in files&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://github.com/pimps/JNDI-Exploit-Kit&quot;
              date = &quot;2021-12-12&quot;
              score = 60
           strings:
              $x01 = &quot;/Basic/Command/Base64/&quot;
              $x02 = &quot;/Basic/ReverseShell/&quot;
              $x03 = &quot;/Basic/TomcatMemshell&quot;
              $x04 = &quot;/Basic/JettyMemshell&quot;
              $x05 = &quot;/Basic/WeblogicMemshell&quot;
              $x06 = &quot;/Basic/JBossMemshell&quot;
              $x07 = &quot;/Basic/WebsphereMemshell&quot;
              $x08 = &quot;/Basic/SpringMemshell&quot;
              $x09 = &quot;/Deserialization/URLDNS/&quot;
              $x10 = &quot;/Deserialization/CommonsCollections1/Dnslog/&quot;
              $x11 = &quot;/Deserialization/CommonsCollections2/Command/Base64/&quot;
              $x12 = &quot;/Deserialization/CommonsBeanutils1/ReverseShell/&quot;
              $x13 = &quot;/Deserialization/Jre8u20/TomcatMemshell&quot;
              $x14 = &quot;/TomcatBypass/Dnslog/&quot;
              $x15 = &quot;/TomcatBypass/Command/&quot;
              $x16 = &quot;/TomcatBypass/ReverseShell/&quot;
              $x17 = &quot;/TomcatBypass/TomcatMemshell&quot;
              $x18 = &quot;/TomcatBypass/SpringMemshell&quot;
              $x19 = &quot;/GroovyBypass/Command/&quot;
              $x20 = &quot;/WebsphereBypass/Upload/&quot;

              $fp1 = &quot;&lt;html&quot;
           condition:
              1 of ($x*) and not 1 of ($fp*)
        }

        rule EXPL_Log4j_CVE_2021_44228_JAVA_Exception_Dec21_1 {
           meta:
              description = &quot;Detects exceptions found in server logs that indicate an exploitation attempt of CVE-2021-44228&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://gist.github.com/Neo23x0/e4c8b03ff8cdf1fa63b7d15db6e3860b&quot;
              date = &quot;2021-12-12&quot;
              score = 60
           strings:
              $xa1 = &quot;header with value of BadAttributeValueException: &quot;

              $sa1 = &quot;.log4j.core.net.JndiManager.lookup(JndiManager&quot;
              $sa2 = &quot;Error looking up JNDI resource&quot;
           condition:
              $xa1 or all of ($sa*)
        }

        rule EXPL_Log4j_CVE_2021_44228_Dec21_Soft {
           meta:
              description = &quot;Detects indicators in server logs that indicate an exploitation attempt of CVE-2021-44228&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://twitter.com/h113sdx/status/1469010902183661568?s=20&quot;
              date = &quot;2021-12-10&quot;
              modified = &quot;2021-12-13&quot;
              score = 60
           strings:
              $x01 = &quot;${jndi:ldap:/&quot;
              $x02 = &quot;${jndi:rmi:/&quot;
              $x03 = &quot;${jndi:ldaps:/&quot;
              $x04 = &quot;${jndi:dns:/&quot;
              $x05 = &quot;${jndi:iiop:/&quot;
              $x06 = &quot;${jndi:http:/&quot;
              $x07 = &quot;${jndi:nis:/&quot;
              $x08 = &quot;${jndi:nds:/&quot;
              $x09 = &quot;${jndi:corba:/&quot;

              $fp1 = &quot;&lt;html&quot;
           condition:
              1 of ($x*) and not 1 of ($fp*)
        }

        rule EXPL_Log4j_CVE_2021_44228_Dec21_OBFUSC {
           meta:
              description = &quot;Detects obfuscated indicators in server logs that indicate an exploitation attempt of CVE-2021-44228&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://twitter.com/h113sdx/status/1469010902183661568?s=20&quot;
              date = &quot;2021-12-12&quot;
              modified = &quot;2021-12-13&quot;
              score = 60
           strings:
              $x1 = &quot;$%7Bjndi:&quot;
              $x2 = &quot;%2524%257Bjndi&quot;
              $x3 = &quot;%2F%252524%25257Bjndi%3A&quot;
              $x4 = &quot;${jndi:${lower:&quot;
              $x5 = &quot;${::-j}${&quot;
              $x6 = &quot;${${env:BARFOO:-j}&quot;
              $x7 = &quot;${::-l}${::-d}${::-a}${::-p}&quot;
              $x8 = &quot;${base64:JHtqbmRp&quot;

              $fp1 = &quot;&lt;html&quot;
           condition:
              1 of ($x*) and not 1 of ($fp*)
        }

        rule EXPL_Log4j_CVE_2021_44228_Dec21_Hard {
           meta:
              description = &quot;Detects indicators in server logs that indicate the exploitation of CVE-2021-44228&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://twitter.com/h113sdx/status/1469010902183661568?s=20&quot;
              date = &quot;2021-12-10&quot;
              modified = &quot;2021-12-12&quot;
              score = 80
           strings:
              $x1 = /\$\{jndi:(ldap|ldaps|rmi|dns|iiop|http|nis|nds|corba):\/[\/]?[a-z-\.0-9]{3,120}:[0-9]{2,5}\/[a-zA-Z\.]{1,32}\}/
              $x2 = &quot;Reference Class Name: foo&quot;
              $fp1r = /(ldap|rmi|ldaps|dns):\/[\/]?(127\.0\.0\.1|192\.168\.|172\.[1-3][0-9]\.|10\.)/
           condition:
              1 of ($x*) and not 1 of ($fp*)
        }

        rule SUSP_Base64_Encoded_Exploit_Indicators_Dec21 {
           meta:
              description = &quot;Detects base64 encoded strings found in payloads of exploits against log4j CVE-2021-44228&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://twitter.com/Reelix/status/1469327487243071493&quot;
              date = &quot;2021-12-10&quot;
              modified = &quot;2021-12-13&quot;
              score = 70
           strings:
              /* curl -s  */
              $sa1 = &quot;Y3VybCAtcy&quot;
              $sa2 = &quot;N1cmwgLXMg&quot;
              $sa3 = &quot;jdXJsIC1zI&quot;
              /* |wget -q -O-  */
              $sb1 = &quot;fHdnZXQgLXEgLU8tI&quot;
              $sb2 = &quot;x3Z2V0IC1xIC1PLS&quot;
              $sb3 = &quot;8d2dldCAtcSAtTy0g&quot;

              $fp1 = &quot;&lt;html&quot;
           condition:
              1 of ($sa*) and 1 of ($sb*)
              and not 1 of ($fp*)
        }

        rule SUSP_JDNIExploit_Indicators_Dec21 {
           meta:
              description = &quot;Detects indicators of JDNI usage in log files and other payloads&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://github.com/flypig5211/JNDIExploit&quot;
              date = &quot;2021-12-10&quot;
              modified = &quot;2021-12-12&quot;
              score = 70
           strings:
              $xr1 = /(ldap|ldaps|rmi|dns|iiop|http|nis|nds|corba):\/\/[a-zA-Z0-9\.]{7,80}:[0-9]{2,5}\/(Basic\/Command\/Base64|Basic\/ReverseShell|Basic\/TomcatMemshell|Basic\/JBossMemshell|Basic\/WebsphereMemshell|Basic\/SpringMemshell|Basic\/Command|Deserialization\/CommonsCollectionsK|Deserialization\/CommonsBeanutils|Deserialization\/Jre8u20\/TomcatMemshell|Deserialization\/CVE_2020_2555\/WeblogicMemshell|TomcatBypass|GroovyBypass|WebsphereBypass)\//
           condition:
              filesize &lt; 100MB and $xr1
        }

        rule SUSP_EXPL_OBFUSC_Dec21_1{
           meta:
              description = &quot;Detects obfuscation methods used to evade detection in log4j exploitation attempt of CVE-2021-44228&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://twitter.com/testanull/status/1469549425521348609&quot;
              date = &quot;2021-12-11&quot;
              score = 60
           strings:
              /* ${lower:X} - single character match */
              $x1 = { 24 7B 6C 6F 77 65 72 3A ?? 7D }
              /* ${upper:X} - single character match */
              $x2 = { 24 7B 75 70 70 65 72 3A ?? 7D }
              /* URL encoded lower - obfuscation in URL */
              $x3 = &quot;$%7blower:&quot;
              $x4 = &quot;$%7bupper:&quot;
              $x5 = &quot;%24%7bjndi:&quot;
              $x6 = &quot;$%7Blower:&quot;
              $x7 = &quot;$%7Bupper:&quot;
              $x8 = &quot;%24%7Bjndi:&quot;

              $fp1 = &quot;&lt;html&quot;
           condition:
              1 of ($x*) and not 1 of ($fp*)
        }

        rule SUSP_JDNIExploit_Error_Indicators_Dec21_1 {
           meta:
              description = &quot;Detects error messages related to JDNI usage in log files that can indicate a Log4Shell / Log4j exploitation&quot;
              author = &quot;Florian Roth&quot;
              reference = &quot;https://twitter.com/marcioalm/status/1470361495405875200?s=20&quot;
              date = &quot;2021-12-10&quot;
              modified = &quot;2021-12-13&quot;
              score = 70
           strings:
              $x1 = &quot;FATAL log4j - Message: BadAttributeValueException: &quot;
           condition:
              $x1
        }

sources:
  - query: |
      -- check which Yara to use
      LET yara = SELECT * FROM if(condition=YaraUrl,
            then= { SELECT Content FROM http_client( url=YaraUrl, method='GET') },
            else= if(condition=ShortHandYara,
                then= { SELECT ShortHandYara as Content FROM scope() },
                else= { SELECT YaraRule as Content FROM scope() }))
                
      -- time testing
      LET time_test(stamp) = 
            if(condition= DateBefore AND DateAfter,
                then= stamp &lt; DateBefore AND stamp &gt; DateAfter,
                else= 
            if(condition=DateBefore,
                then= stamp &lt; DateBefore,
                else= 
            if(condition= DateAfter,
                then= stamp &gt; DateAfter,
                else= True
            )))
      
      -- first find all matching glob
      LET files = SELECT FullPath, Name, Size , Mtime, Atime, Ctime, Btime
        FROM glob(globs=PathGlob,nosymlink='True')
        WHERE 
          NOT IsDir AND NOT IsLink
          AND if(condition=SizeMin,
            then= SizeMin &lt; Size,
            else= True)
          AND if(condition=SizeMax,
            then=SizeMax &gt; Size,
            else= True)
          AND 
             ( time_test(stamp=Mtime)
            OR time_test(stamp=Atime)
            OR time_test(stamp=Ctime)
            OR time_test(stamp=Btime))

      LET hits = SELECT * FROM foreach(row=files,
            query={
                SELECT
                    url(parse=FileName).Path as FullPath,
                    Size,
                    Mtime, Atime, Ctime, Btime,
                    Rule, Tags, Meta,
                    str(str=String.Data) AS HitContext,
                    String.Offset AS HitOffset
                FROM yara(rules=yara.Content[0],files=url(path=FullPath, scheme=&quot;file&quot;), accessor='gzip')
                LIMIT 1
            })
      
      -- upload files that have hit
      LET upload_hits=SELECT *,
            upload(file=FullPath) AS Upload
        FROM hits

      -- return rows
      SELECT * FROM if(condition=UploadHits,
        then=upload_hits,
        else=hits)

</code></pre>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1640222966></script>
<script src=/js/perfect-scrollbar.min.js?1640222966></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1640222966></script>
<script src=/js/jquery.sticky.js?1640222966></script>
<script src=/js/featherlight.min.js?1640222966></script>
<script src=/js/highlight.min.js?1640222966></script>
<script>hljs.highlightAll()</script>
<script src=/js/modernizr.custom-3.6.0.js?1640222966></script>
<script src=/js/learn.js?1640222966></script>
<script src=/js/hugo-learn.js?1640222966></script>
</body>
</html>