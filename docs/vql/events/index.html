<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.88.1">
<meta name=description content>
<link rel=icon href=/images/favicon.png type=image/png>
<title>Event Queries :: Velociraptor - Digging deeper!</title>
<link href=/css/nucleus.css?1630839797 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1630839797 rel=stylesheet>
<link href=/css/featherlight.min.css?1630839797 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1630839797 rel=stylesheet>
<link href=/css/auto-complete.css?1630839797 rel=stylesheet>
<link href=/css/theme.css?1630839797 rel=stylesheet>
<link href=/css/tabs.css?1630839797 rel=stylesheet>
<link href=/css/hugo-theme.css?1630839797 rel=stylesheet>
<link href=/css/theme-mine.css?1630839797 rel=stylesheet>
<link href=/css/dark.css?1630839797 rel=stylesheet><link href=/css/syntax.css?1630839797 rel=stylesheet><link href=/css/light.css?1630839797 rel=stylesheet><link href=/css/hljs.css?1630839797 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1630839797 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1630839797></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<script></script>
</head>
<body data-url=/docs/vql/events/>
<nav id=sidebar><div id=header-wrapper>
<div id=header>
<script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script>
<div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()>
<i class="fas fa-moon"></i>
</div>
<div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()>
<i class="fas fa-sun"></i>
</div>
<a href=https://docs.velociraptor.app/>
<img src=https://docs.velociraptor.app//images/logo.svg>
</a>
</div>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/announcements/2021-artifact-contest/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2021-artifact-contest/>2021 Contest</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item parent haschildren">
<div>
<i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item parent haschildren">
<div>
<i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class="dd-item parent active">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a>
</div>
</li>
</ul>
</li><hr>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a>
</div>
</li>
</ul>
<hr>
<section id=shortcuts>
<h3></h3>
<ul>
<li>
<a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a>
</li>
<li>
<a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a>
</li>
<li>
<a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a>
</li>
</ul>
</section>
<section id=footer>
<div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7>
<br> <i class="fas fa-copyright"></i> 2021
</div>
</section>
</div>
</nav>
<script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=top-github-link>
<a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/docs/vql/events/_index.md target=blank>
<i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span>
</a>
</div>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
Event Queries
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#example>Example</a></li>
<li><a href=#client-monitoring-architecture>Client monitoring architecture</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
Event Queries
</h1>
<div class="author pull-right">
<span class=date>2021-06-12</span>
</div>
<p>Normally a VQL query returns a result set and then terminates. For
example, consider the <code>glob()</code> plugin which searches the filesystem
for files matching a pattern. While it may take a few minutes to fully
traverse the entire filesystem, as soon as a matching file is found,
the row is emitted from the plugin asynchronously.</p>
<p>VQL queries are always asynchronous which means that as soon as
results are available, they are emitted into the query, and can
potentially be relayed back to the server - even if the plugin takes a
very long time to run.</p>
<p>Consider now a VQL plugin that takes a long time to complete, perhaps even days. As soon as a result is available, a row will be emitted and will be relayed to the server. Now what if the plugin emits a row based on an event occuring?</p>
<p>When the event occurs, the plugin will asynchronously emit a row
describing the event, and go back to monitoring for the event
again. This type of plugin is called an <code>Event Plugin</code> because it
never terminates - instead it emits a row when an event occur. The
entire VQL query is blocked waiting for the event.</p>
<p>A Query that is waiting on an event (i.e. it is selecting from an
event plugin) is called an <code>Event Query</code>. Event queries do not
terminate on their own - they simply return partial results until
cancelled.</p>
<p>
<figure>
<img src=eventquery.png alt="Event Query" class=captioned>
<figcaption>Event Query</figcaption>
</figure>
</p>
<p>The diagram above illustrates how partial results are send to the
server. As events occur at random times on the endpoint, the event
plugin will emit rows into the query at random times. In order to
minimize frequent communicating with the server, the client will batch
rows into partial results sets which will be forwarded periodically to
the server.</p>
<h2 id=example>Example</h2>
<p>You can get the feel of event queries by typing the following query
into a notebook</p>
<pre><code class=language-sql>SELECT Unix FROM clock()
</code></pre>
<p>The <code>clock()</code> plugin simply emits one row per second. The GUI will be
waiting for the query to complete, showing partial results as it goes
along. Of course the query will not complete by itsef, only when it
hits the notebook&rsquo;s 10 Minute timeout or the user clicks the <code>Stop</code>
<i class="fas fa-stop"></i> button.</p>
<p>
<figure>
<img src=image65.png alt=Clock class=captioned>
<figcaption>Clock</figcaption>
</figure>
</p>
<h2 id=client-monitoring-architecture>Client monitoring architecture</h2>
<p>The client maintains a set of VQL Event Queries that are all run in
parallel. This is called the <code>Client's Event Table</code> and it gets synced
from the server when needed.</p>
<p>When any of these produce rows, the client streams them to the server
which writes them to the filestore.</p>
<p>If the client is offline, these will be queued in the clientâ€™s local
file buffer, until the client reconnects again, at which time they are
synced back to the server. This architecture ensures that clients can
not lose events, event when not online.</p>
<p>
<figure>
<img src=client_events_arch.png alt="Client Event Architecture" class=captioned>
<figcaption>Client Event Architecture</figcaption>
</figure>
</p>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1630839797></script>
<script src=/js/perfect-scrollbar.min.js?1630839797></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1630839797></script>
<script src=/js/jquery.sticky.js?1630839797></script>
<script src=/js/featherlight.min.js?1630839797></script>
<script src=/js/highlight.min.js?1630839797></script>
<script>hljs.highlightAll()</script>
<script src=/js/modernizr.custom-3.6.0.js?1630839797></script>
<script src=/js/learn.js?1630839797></script>
<script src=/js/hugo-learn.js?1630839797></script>
</body>
</html>