<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.97.3"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Volatile machine state :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1651106944 rel=stylesheet><link href=/css/fontawesome-all.min.css?1651106944 rel=stylesheet><link href=/css/featherlight.min.css?1651106944 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1651106944 rel=stylesheet><link href=/css/auto-complete.css?1651106944 rel=stylesheet><link href=/css/theme.css?1651106944 rel=stylesheet><link href=/css/tabs.css?1651106944 rel=stylesheet><link href=/css/hugo-theme.css?1651106944 rel=stylesheet><link href=/css/theme-mine.css?1651106944 rel=stylesheet><link href=/css/dark.css?1651106944 rel=stylesheet><link href=/css/syntax.css?1651106944 rel=stylesheet><link href=/css/light.css?1651106944 rel=stylesheet><link href=/css/hljs.css?1651106944 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1651106944 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1651106944></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYH72LMYCS",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-QYH72LMYCS","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script></script></head><body data-url=/docs/forensic/volatile/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp("theme=darkmode");regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a></div><ul><li data-nav-id=https://docs.velociraptor.app/announcements/2022-velocon/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2022-velocon/>2022 VeloCon</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class="dd-item parent active"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a></div></li></ul></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a></div><ul><li data-nav-id=https://docs.velociraptor.app/presentations/2021_auscert/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_auscert/>Auscert 2021</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2021_osdfc/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_osdfc/>OSDFC 2021</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2021_blueteam_village/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_blueteam_village/>BTV 2021</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/knowledge_base/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/knowledge_base/><i class="fas fa-brain"></i>Knowledge Base</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a></li><li><a class=padding href=https://docs.velociraptor.app/rss/><i class="fas fa-rss"></i>RSS</a></li></ul></section><section id=footer><div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/Velocidex/velociraptor-docs/edit/master/content/docs/forensic/volatile/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Volatile machine state</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#windows-management-instrumentation-wmi>Windows Management Instrumentation (WMI)</a></li><li><a href=#mutants>Mutants</a><ul><li><a href=#exercise---mutants>Exercise - Mutants</a></li><li><a href=#enumerate-the-mutants>Enumerate the mutants</a></li></ul></li><li><a href=#process-analysis>Process analysis</a><ul><li><a href=#pslist>pslist</a></li><li><a href=#process-call-chain>Process Call chain</a></li><li><a href=#example---find-elevated-command-shell>Example - Find elevated command shell</a></li></ul></li><li><a href=#mapped-memory>Mapped Memory</a><ul><li><a href=#exercise---what-is-that-powershell-doing>Exercise - what is that powershell doing?</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Volatile machine state</h1><p>Traditional forensic analysis relies on filesystem artifacts. However,
one of the best advantages of performing live response is the ability
to access the live system&rsquo;s state and uncover volatile indicators that
only exist briefly and might change in future.</p><div class="mynotices note"><div heading=" Memory analysis and Velociraptor "><p>Traditionally volatile evidence was acquired using a full memory dump
of the running system, and then using a number of memory analysis
frameworks to extract some of the types of forensic artifacts we
discuss in this page.</p><p>While memory analysis is a sometimes useful technique, it is
notoriously unreliable due to issues such as smear, stability and
analysis shortfalls due to changing OS and application code.</p><p>An important principle of volatile system analysis is to disturb the
system as little as possible, to avoid increasing the rate at which
the volatile evidence might change. A full memory acquisition defeats
this requirement by causing a very large amount of data to be written
and potentially transferred over the network. Some server class
machines (or even high end workstations) currently contain so much
memory that full acquisition is actually not practical (e.g. upwards
of 64Gb of RAM is not uncommon), and produces significant amounts of
smear.</p><p>Velociraptor&rsquo;s approach is to use the relevant APIs to acquire
volatile artifacts as much as possible, so the acquisition can be made
quickly, accurately and with minimal endpoint impact. Velociraptor
tries to maintain the same names for the common plugins used by
popular memory analysis tools like Volatility, but gets the same
information using APIs (e.g. Velociraptor&rsquo;s plugins are named
<code>pslist</code>, <code>vad</code>, <code>mutants</code> etc and parallel Volatility&rsquo;s plugins of
the same name).</p></div></div><h2 id=windows-management-instrumentation-wmi>Windows Management Instrumentation (WMI)</h2><p>One of the earliest mechanisms for introspecting a machine&rsquo;s internal
state is using WMI. WMI provides a simple query language similar to
SQL called WQL (WMI Query Language). In WQL, a &ldquo;table&rdquo; is referred to
as a &ldquo;class&rdquo; and Windows provides a large number of classes organized
into namespaces.</p><p>It is most instructive to explore these using a tool such as <a href=https://github.com/vinaypamnani/wmie2>wmie2</a>.</p><p><figure><img src=image39.png alt="Exploring WMI with WMIE2" class=captioned><figcaption>Exploring WMI with WMIE2</figcaption></figure></p><p>VQL provides direct access to WMI via the <code>wmi()</code> plugin. The plugin
simply takes a <code>query</code> parameter which is passed to WMI and the
results are emitted from the plugin one row at a time.</p><pre><code class=language-sql>SELECT * FROM wmi(query=&quot;SELECT * FROM Win32_DiskDrive&quot;)
</code></pre><p>There are many providers in WMI and it is possible to gather a lot of
information about the system&rsquo;s current configuration and state in this
way. Use a tool such as <code>wmie2</code> to figure out interesting providers
and structure VQL queries around these. Note that with VQL you are
also able to combine functions like <code>upload()</code>, <code>hash()</code> and others to
further enrich the output from WMI providers.</p><h2 id=mutants>Mutants</h2><p>Malware typically need to persist using multiple persistence
mechanisms - in case one mechanism is detected and removed, often
other mechanisms will re-infect the machine. This leaves a common
problem: How to avoid multiple copies of the same malware from
running?</p><p>A common solution is using a <code>Mutant</code> or a named mutex object. A
Mutant is a named kernel object that can only be &ldquo;acquired&rdquo; by one
thread at a time. Multiple copies of the same malware will try to
acquire the mutant, but only the first will succeed, leaving the rest
to exit.</p><p>For this reason, a mutant is frequently used as an indicator for a
malware strain because it is easy to see if the mutant name exists on
a system.</p><h3 id=exercise---mutants>Exercise - Mutants</h3><p>For example, consider the following powershell snippet:</p><pre><code class=language-powershell>$createdNew = $False
$mutex = New-Object -TypeName System.Threading.Mutex(
      $true, &quot;Global\MyBadMutex&quot;, [ref]$createdNew)
if ($createdNew) {
    echo &quot;Acquired Mutex&quot;
    sleep(1000)
} else {
    echo &quot;Someone else has the mutex&quot;
}
</code></pre><p>The first time it is run, the mutant will be &ldquo;acquired&rdquo; and the
program will simply go to sleep. Further instances of the script will
be unable to acquire the mutant and will exit immediately.</p><h3 id=enumerate-the-mutants>Enumerate the mutants</h3><p>You can enumerate the mutant using the <code>Windows.Detection.Mutants</code>
artifact. This artifact can be used to collect all mutants (and
perhaps do some analysis on their names) or to check for some well
known names using a filter (in which case a hit represents a strong
signal that endpoint is compromised).</p><p><figure><img src=image35.png alt="Listing mutants" class=captioned><figcaption>Listing mutants</figcaption></figure></p><h2 id=process-analysis>Process analysis</h2><p>A process is a user space task with a specific virtual memory
layout. A process has a name, Process ID (Pid), an initial binary on
disk, an ACL Token, environment variables etc. All of these associated
attributes can be used to explain why the process is launched and what
its intentions are.</p><p>Velociraptor provides access to various process attributes using
process specific plugins. Most of these plugins accept a <code>pid</code>
argument to examine a specific process.</p><h3 id=pslist>pslist</h3><p>A simple <code>pslist()</code> can reveal basic information about the process:</p><ul><li>Who launched the binary? (Username and SID)</li><li>Transfer metrics (network/disk activity)</li><li>Is it elevated?</li><li>Process Creation time</li><li>Executable location on disk</li><li>Commandline for launching the process.</li></ul><p><figure><img src=image38.png alt="Process listing with the pslist() plugin" class=captioned><figcaption>Process listing with the pslist() plugin</figcaption></figure></p><h3 id=process-call-chain>Process Call chain</h3><p>A process call chain is useful to see which process launched which
other process. Artifacts such as <code>Windows.System.Pstree</code> attempt to
put processes in a parent/child relationship (i.e. Process chain) to
try to visualize the order of process execution.</p><p><figure><img src=image40.png alt="Identifying process call chains" class=captioned><figcaption>Identifying process call chains</figcaption></figure></p><div class="mynotices warning"><div heading=" Shortfalls of process call chain tracing "><p>Currently the process chain reassembly is susceptible to some
shortfalls:</p><ol><li><p>Since the chain uses <code>pslist()</code> to populate its tree, processes who
are exited will break the chain (because there will be no parent
shown for one process in the chain).</p></li><li><p>Windows parent/child relationship can be easily <a href=https://attack.mitre.org/techniques/T1134/004/>spoofed by
malware</a> and can be
mis-reported by the pslist() plugin.</p></li></ol></div></div><h3 id=example---find-elevated-command-shell>Example - Find elevated command shell</h3><p>Write an artifact to find all currently running elevated command shells</p><pre><code class=language-sql>SELECT * FROM pslist()
WHERE TokenIsElevated
</code></pre><h2 id=mapped-memory>Mapped Memory</h2><p>When a binary runs it links many DLLs into it in order to call
functions from these dlls. A linked DLL is a copy on write memory
mapping of a file on disk into the process memory space. DLLs can be
linked when the program starts or dynamically at runtime.</p><p>Seeing which DLL is linked gives a clue of the type of functionality
that a process is likely to use.</p><p>The <code>vad()</code> plugin shows all the process memory regions and if the
memory is mapped to file, the filename it is mapped from.</p><p>For interpreted languages like .net assemblies, powershell or python DLLs are mapped into the process at runtime when the script imports certain functionality. We can use this to get an idea of what the program is doing.</p><h3 id=exercise---what-is-that-powershell-doing>Exercise - what is that powershell doing?</h3><p>Without enabling powershell block logging, we can get an idea of what the script is doing by looking at its dependencies.</p><p>Consider a powershell script that runs <code>Invoke-WebRequest -Uri "https://www.google.com" -UseBasicParsing</code> to download a page from the
internet. By virtue of this command, the powershell process will link
<code>winhttp.dll</code>.</p><p>We can write VQL to list all the DLL modules that powershell is running.</p><pre><code class=language-sql>LET processes = SELECT Exe, CommandLine, Pid
FROM pslist()
WHERE Exe =~ 'PowerShell'

SELECT * FROM foreach(row=processes,
query={
   SELECT Exe, CommandLine, Pid, MappingName
   FROM vad(pid=Pid)
   GROUP BY MappingName
})
WHERE MappingName =~ 'winhttp'
</code></pre><footer class=footline></footer></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//velocidex-velociraptor.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1651106944></script>
<script src=/js/perfect-scrollbar.min.js?1651106944></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1651106944></script>
<script src=/js/jquery.sticky.js?1651106944></script>
<script src=/js/featherlight.min.js?1651106944></script>
<script src=/js/highlight.min.js?1651106944></script>
<script>hljs.highlightAll()</script><script src=/js/modernizr.custom-3.6.0.js?1651106944></script>
<script src=/js/learn.js?1651106944></script>
<script src=/js/hugo-learn.js?1651106944></script></body></html>