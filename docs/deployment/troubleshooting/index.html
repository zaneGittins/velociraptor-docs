<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.108.0"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Troubleshooting Deployments :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1671284792 rel=stylesheet><link href=/css/fontawesome-all.min.css?1671284792 rel=stylesheet><link href=/css/featherlight.min.css?1671284792 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1671284792 rel=stylesheet><link href=/css/auto-complete.css?1671284792 rel=stylesheet><link href=/css/theme.css?1671284792 rel=stylesheet><link href=/css/tabs.css?1671284792 rel=stylesheet><link href=/css/hugo-theme.css?1671284792 rel=stylesheet><link href=/css/theme-mine.css?1671284792 rel=stylesheet><link href=/css/dark.css?1671284792 rel=stylesheet><link href=/css/syntax.css?1671284792 rel=stylesheet><link href=/css/light.css?1671284792 rel=stylesheet><link href=/css/hljs.css?1671284792 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1671284792 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1671284792></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYH72LMYCS",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-QYH72LMYCS","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script></script></head><body data-url=/docs/deployment/troubleshooting/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp("theme=darkmode");regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class="dd-item active"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/references/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/references/>Config Reference</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a></div></li></ul></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a></div><ul><li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_auscert/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_auscert/>Auscert 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_us/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_us/>DFRWS US 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_tech_user_group_cbr/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_tech_user_group_cbr/>Tech Users Group 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_sans_summit/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_sans_summit/>SANS Summit 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_velocon/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_velocon/>Velocon 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_apac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_apac/>DFRWS APAC 2022</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/artifact_references/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/artifact_references/><i class="fas fa-book"></i>Artifact Reference</a></div></li><li data-nav-id=https://docs.velociraptor.app/knowledge_base/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/knowledge_base/><i class="fas fa-brain"></i>Knowledge Base</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class='fas fa-search'></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class='fab fa-github'></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class='fab fa-discord'></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class='fas fa-envelope'></i>Mailing List</a></li><li><a class=padding href=https://docs.velociraptor.app/rss/><i class='fas fa-rss'></i>RSS</a></li></ul></section><section id=footer><div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2022</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title='Edit this page' href=https://github.com/Velocidex/velociraptor-docs/edit/master/content/docs/deployment/troubleshooting/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Troubleshooting Deployments</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#server-fails-to-start>Server fails to start</a></li><li><a href=#velociraptor-communications>Velociraptor communications</a><ul><li><a href=#velociraptors-internal-pki>Velociraptor’s internal PKI</a></li><li><a href=#messages>Messages</a></li><li><a href=#http-protocol>HTTP protocol</a></li><li><a href=#tls-verification>TLS verification</a></li></ul></li><li><a href=#debugging-client-communications>Debugging client communications</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Troubleshooting Deployments</h1><p>Sometimes things don&rsquo;t work when you first try them. This page will go
through the common issues people find when deploying Velociraptor
clients and the steps needed to debug them.</p><h2 id=server-fails-to-start>Server fails to start</h2><p>If the server fails to start, you can try to start it by hand to see any logs or issues. Typically the Linux service will report something unhelpful such as:</p><pre><code># service velociraptor_server status
● velociraptor_server.service - Velociraptor linux amd64
    Loaded: loaded (/etc/systemd/system/velociraptor_server.service; enabled; vendor preset: enabled)
    Active: activating (auto-restart) (Result: exit-code) since Fri 2021-12-31 15:32:58 AEST; 1min 1s ago
   Process: 3561364 ExecStart=/usr/local/bin/velociraptor --config /etc/velociraptor/server.config.yaml frontend (code=exited, status=1/FAILURE)
  Main PID: 3561364 (code=exited, status=1/FAILURE)
</code></pre><p>You can usually get more information from the system log files,
usually <code>/var/log/syslog</code>. Alternative you can try to start the
service by hand and see any issues on the console.</p><p>First change to the Velociraptor user and then start the service as that user.</p><pre><code># sudo -u velociraptor bash
$ velociraptor frontend -v
Dec 31 15:47:18 devbox velociraptor[3572509]: velociraptor.bin: error: frontend: loading config file: failed to acquire target io.Writer: failed to create a new file /mnt/data/logs/Velociraptor_debug.log.202112270000: failed to open file /mnt/data/logs/Velociraptor_debug.log.202112270000: open /mnt/data/logs/Velociraptor_debug.log.202112270000: permission denied
</code></pre><p>In this case, Velociraptor can not start because it can not write on
its logs directory. Other errors might be disk full or various permission denied problems.</p><div class="mynotices warning"><div heading=" Incorrect permissions in the filestore "><p>Because Velociraptor normally runs as a low privileged user, it needs
to maintain file ownership as the <code>velociraptor</code> user. Sometimes
permissions change by accident (usually this happens by running
velociraptor as root and interacting with the file store - you should
<strong>always</strong> change to the <code>velociraptor</code> user before interacting with
the server).</p><p>It is worth checking file permissions (using <code>ls -l</code>) and recursively
returning file ownership back to the <code>velociraptor</code> user (using the
command <code>chown -R velociraptor:velociraptor /path/to/filestore/</code>)</p></div></div><h2 id=velociraptor-communications>Velociraptor communications</h2><p>To understand where things might go wrong, we first need to understand
how Velociraptor clients communicate with the server. You can read a lot more details about Velociraptor&rsquo;s encryption scheme and communication protocol in our <a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications Blog post</a>, but we will go through the most important aspects here.</p><h3 id=velociraptors-internal-pki>Velociraptor’s internal PKI</h3><p>Every Velociraptor deployments creates an internal PKI which underpins
it. The configuration wizard create an internal CA with an X509
certificate and a private key. This CA is used to</p><ol><li><p>Create initial server certificates and any additional certificates
for key rotation.</p></li><li><p>CA public certificate is embedded in the client’s configuration and
is used to verify server communications.</p></li><li><p>The CA is used to create API keys for programmatic access. The
server is then able to verify API clients.</p></li></ol><p>The configuration file contains the CA&rsquo;s X509 certificate in the
<strong>Client.ca_certificate</strong> parameter (it is therefore embedded in the
client configuration). The private key is contained in the
<strong>CA.private_key</strong> parameter.</p><div class="mynotices warning"><div heading=" Protecting the CA private key "><p>In a secure installation you should remove the <strong>CA.private_key</strong>
section from the server config and keep it offline. You only need it
to create new API keys using the <em>velociraptor config api_client</em>
command, and the server does not need it in normal operations.</p></div></div><h3 id=messages>Messages</h3><p>Clients and servers communicate by sending each other messages (which
are simply protocol buffers), for example, a message may contain VQL
queries or result sets. Messages are collected into a list and sent in
a single POST operation in a <strong>MessageList</strong> protobuf. This protobuf
is encrypted using a session key with a symmetric cipher
(<code>aes_128_cbc</code>). The session key is chosen by the sending party and is
written into an encrypted <strong>Cipher</strong> protobuf and sent along with each
message.</p><p><figure><img src=1ntQkR2sRm8mIg5vkYjngEg.png alt="Velociraptor Communication overview" class=captioned><figcaption>Velociraptor Communication overview</figcaption></figure></p><p>This symmetric key is encoded in a <strong>Cipher Properties</strong> protobuf
which is encrypted in turn using the receiving party’s public key and
signed using the sending party’s private key.</p><div class="mynotices tip"><div heading=" Messages are double encrypted "><p>You might have noticed that <strong>MessageList</strong> protobufs are encrypted
and signed, but they are usually still delivered within a TLS session -
therefore there are two layers of encryption.</p><p>The internal encryption scheme&rsquo;s main purpose is not to encrypt the
messages but to sign them. This prevents messages from one client from
impersonating another client.</p></div></div><h3 id=http-protocol>HTTP protocol</h3><p>Velociraptor uses HTTPS POST messages to deliver message sets to the
server. The server in turn sends messages to the client in the body of
the POST request. The client connects to one of the server URLs
provided in the <strong>Client.server_urls</strong> setting in its config file.</p><p>Before the client communicates with the server, the client must verify
it is actually talking with the correct server. This happens at two
levels:</p><ul><li><p>If the URL is a HTTPS URL then the TLS connection needs to be
verified</p></li><li><p>The client will fetch the url /server.pem to receive the server’s
internal certificate. This certificate must be verified by the
embedded CA.</p></li></ul><p>Note that this verification is essential in order to prevent the
client from accidentally talking with captive portals or MITM proxies.</p><h3 id=tls-verification>TLS verification</h3><p>Velociraptor currently supports 2 modes for deployment via the config
wizard:</p><ul><li><p>Self signed mode uses internal CAs for the TLS certificates. The
client knows it is in self signed mode if the
<strong>Client.use_self_signed_ssl</strong> flag is true.</p></li><li><p>Proper certificates minted by Let’s encrypt.</p></li></ul><p>Velociraptor verifies self signed TLS certificates using its built in
CA. This essentially pins the server’s certificate inside the client —
even if a MITM was able to mint another certificate (even if it was
trusted by the global roots!) it would not be valid since it was not
issued by Velociraptor’s internal CA which is the only CA we trust in
this mode! In this way self signed mode is more secure than when using
a public CA.</p><p>The <strong>Client.pinned_server_name</strong> specifies the common name of the
server (or DNS name in the Server Alternate Name (SAN) field). The
client verifies that the certificate is correct <strong>AND</strong> that the name
is the same as the pinned name. You typically do not need to change
this setting.</p><p>If the client is not in self signed mode
(i.e. <strong>Client.use_self_signed_ssl</strong> is false or not present), it
expects to verify TLS connections using the system’s root certificate
store. In this configuration, Velociraptor may be susceptible to a
MITM SSL inspection proxy, and we must rely on the internal encryption
mechanism as described in the previous section to protect
communications.</p><div class="mynotices warning"><div heading=" Self signed TLS certificates "><p>Velociraptor&rsquo;s self signed mode <strong>requires</strong> that the certificates be
issued by Velociraptor itself (the CA is pinned). It is <strong>not
supported</strong> for the server to present self signed certificates
generated by another CA!</p><p>In practice we find that often customer networks do contain SSL
inspection proxies which are using self signed certificates. This
breaks communications between client and server altogether. We
typically prefer to deploy Let’s Encrypt certificates for reliability
and better interoperability with such SSL interception proxies.</p><p>If you encounter an SSL interception proxy that breaks Velociraptor
communications, you may look into ways to whitelist the Velociraptor
server. Many proxies have mechanisms to whitelist certain domains.</p></div></div><h2 id=debugging-client-communications>Debugging client communications</h2><p>Now that we have an understanding on the low level communication
mechanism, let’s try to apply our understanding to debugging common
deployment issues.</p><p>If the client does not appear to properly connect to the server, the
first thing is to run it manually (using the <code>velociraptor --config client.config.yaml client -v</code>
command):</p><p><figure><img src=1TOeyrCcX69mtUdO8E4ZK9g.png alt="Running the client manually" class=captioned><figcaption>Running the client manually</figcaption></figure></p><p>In the above example, I ran the client manually with the -v switch. I
see the client starting up and immediately trying to connect to its
URL (in this case <code>https://test.velocidex-training.com/</code>) However
this fails and the client will wait for a short time before retrying
to connect again.</p><p><figure><img src=1IzCgKdN28sjntuxd9mUJew.png alt="Testing connectivity with curl" class=captioned><figcaption>Testing connectivity with curl</figcaption></figure></p><p>A common problem here is network filtering making it impossible to
reach the server. You can test this by simply running curl with the
server’s URL.</p><p>Once you enable connectivity, you might encounter another problem</p><p><figure><img src=1p3MPNfTbXBzNMs-X4yv4SA.png alt="Captive portal interception" class=captioned><figcaption>Captive portal interception</figcaption></figure></p><p>The <strong>Unable to parse PEM</strong> message indicates that the client is
trying to fetch the <strong>server.pem</strong> file but it is not able to validate
it. This often happens with captive portal type of proxies which
interfere with the data transferred. It can also happen if your DNS
setting point to a completely different server.</p><p>We can verify the <strong>server.pem</strong> manually by using curl (note that
when using self signed mode you might need to provide curl with the -k
flag to ignore the certificate errors):</p><p><figure><img src=1P9W4CnX9qNLGiRgnHGyLAw.png alt="Fetching the server certificate" class=captioned><figcaption>Fetching the server certificate</figcaption></figure></p><p>Note that the <strong>server.pem</strong> is always signed by the velociraptor
internal CA in all deployment modes (even with lets encrypt). You can
view the certificate details by using openssl:</p><pre><code class=language-bash>curl https://test.velocidex-training.com/server.pem | openssl x509 -text
</code></pre><p>If your server certificate has expired, the client will refuse to
connect to it. To reissue the server certificate simply recreate the
server configuration file (after suitably backing up the previous
config file):</p><pre><code class=language-bash>velociraptor --config server.config.yaml config rotate_key &gt; new_server.config.yaml
</code></pre><div class="mynotices warning"><div heading=" CA certificate expiry "><p>The above step was able to use the internal Velociraptor CA to reissue
the server certificate (which is normally issued for 1 year), allowing
us to rotate the certificate.</p><p>Currently there is no way to update the CA certificate without
redeploying new clients (the CA certificate is embedded in the client
config file). When generating the config file initially, the CA
certificate is created with a 10 year validity.</p></div></div><footer class=footline></footer></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//velocidex-velociraptor.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1671284792></script>
<script src=/js/perfect-scrollbar.min.js?1671284792></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1671284792></script>
<script src=/js/jquery.sticky.js?1671284792></script>
<script src=/js/featherlight.min.js?1671284792></script>
<script src=/js/highlight.min.js?1671284792></script>
<script>hljs.highlightAll()</script><script src=/js/modernizr.custom-3.6.0.js?1671284792></script>
<script src=/js/learn.js?1671284792></script>
<script src=/js/hugo-learn.js?1671284792></script></body></html>