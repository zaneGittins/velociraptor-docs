<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.92.2">
<meta name=description content>
<link rel=icon href=/images/favicon.png type=image/png>
<title>Multi-Frontend Configuration :: Velociraptor - Digging deeper!</title>
<link href=/css/nucleus.css?1645057811 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1645057811 rel=stylesheet>
<link href=/css/featherlight.min.css?1645057811 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1645057811 rel=stylesheet>
<link href=/css/auto-complete.css?1645057811 rel=stylesheet>
<link href=/css/theme.css?1645057811 rel=stylesheet>
<link href=/css/tabs.css?1645057811 rel=stylesheet>
<link href=/css/hugo-theme.css?1645057811 rel=stylesheet>
<link href=/css/theme-mine.css?1645057811 rel=stylesheet>
<link href=/css/dark.css?1645057811 rel=stylesheet><link href=/css/syntax.css?1645057811 rel=stylesheet><link href=/css/light.css?1645057811 rel=stylesheet><link href=/css/hljs.css?1645057811 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1645057811 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1645057811></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYH72LMYCS',{anonymize_ip:!1})}</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYH72LMYCS','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script></script>
</head>
<body data-url=/docs/deployment/cloud/multifrontend/>
<nav id=sidebar><div id=header-wrapper>
<div id=header>
<script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script>
<div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()>
<i class="fas fa-moon"></i>
</div>
<div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()>
<i class="fas fa-sun"></i>
</div>
<a href=https://docs.velociraptor.app/>
<img src=https://docs.velociraptor.app//images/logo.svg>
</a>
</div>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/announcements/2021-artifact-contest/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2021-artifact-contest/>2021 Contest</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item parent haschildren">
<div>
<i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item parent haschildren">
<div>
<i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item parent haschildren">
<div>
<i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class="dd-item parent active">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a>
</div>
</li>
</ul>
</li>
</ul>
</li><hr>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_auscert/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_auscert/>Auscert 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_osdfc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_osdfc/>OSDFC 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_blueteam_village/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_blueteam_village/>BTV 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a>
</div>
</li>
</ul>
<hr>
<section id=shortcuts>
<h3></h3>
<ul>
<li>
<a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a>
</li>
<li>
<a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a>
</li>
<li>
<a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a>
</li>
</ul>
</section>
<section id=footer>
<div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7>
<br> <i class="fas fa-copyright"></i> 2021
</div>
</section>
</div>
</nav>
<script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=top-github-link>
<a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/docs/deployment/cloud/multifrontend/_index.md target=blank>
<i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span>
</a>
</div>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
Multi-Frontend Configuration
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#scaling-velociraptor>Scaling Velociraptor</a>
<ul>
<li><a href=#what-are-the-bottlenecks-of-scale>What are the bottlenecks of scale?</a></li>
</ul>
</li>
<li><a href=#adding-more-frontend-servers>Adding more frontend servers</a>
<ul>
<li><a href=#storage-requirements>Storage requirements</a></li>
<li><a href=#scaling-storage>Scaling storage</a></li>
<li><a href=#high-latency-filesystems>High latency filesystems</a></li>
</ul>
</li>
<li><a href=#velociraptors-multi-server-design>Velociraptor&rsquo;s multi server design</a>
<ul>
<li><a href=#the-master-node>The Master node</a></li>
<li><a href=#the-minion-node>The Minion node</a></li>
</ul>
</li>
<li><a href=#strategies-to-address-high-latency>Strategies to address high latency</a>
<ul>
<li><a href=#caching>Caching</a></li>
</ul>
</li>
</ul>
<ul>
<li><a href=#making-deb-package>Making deb package.</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
Multi-Frontend Configuration
</h1>
<div class="mynotices warning">
<div heading=warning><p>This configuration is currently considered <strong>experimental!</strong> We have
reports of it working well but there may still be bugs and issues. We
highly recommend that if you intend to run in this mode, please
contact us at <a href=mailto:support@velocidex.com>support@velocidex.com</a> or on discord and provide feedback
or issues.</p>
<p>Being experimental, this feature also falls outside our <a href=/docs/overview/support/>support
policy</a> and features may change
at any time.</p>
</div>
</div>
<p>This page describes the challenges and concepts around scaling
Velociraptor on multiple servers. By understanding the limitations and
challenges of this architecture, as well as the strategies
Velociraptor uses to scale, readers will gain an understanding of the
various configuration parameters that can be used and what they mean.</p>
<h2 id=scaling-velociraptor>Scaling Velociraptor</h2>
<p>Velociraptor is an endpoint visibility tool designed to query a large
number of endpoints quickly and efficiently. In previous releases,
Velociraptor was restricted to a single server performing all
functions, such as serving the GUI, the gRPC API as well as
connections to the clients (endpoint agents). While this architecture
is regularly used to serve up to 10k-15k endpoints, at high number of
endpoints, we are starting to hit limitations with the single server
model.</p>
<h3 id=what-are-the-bottlenecks-of-scale>What are the bottlenecks of scale?</h3>
<p>If you have ever used Velociraptor on a small network of endpoints
(say between 2k-5k endpoints), you would be accustomed to a snappy
GUI, with the ability to query any of the currently connected
endpoints instantly. Velociraptor clients typically do not poll, but
are constantly connected to the serverâ€” this means that when tasking a
new collection on an endpoint, we expect it to respond instantly.</p>
<p>As the number of endpoints increase this performance degrades. When
forwarding a large number of events from the end points, or performing
hunts that transfer a lot of data, one might experience sluggish
performance.</p>
<h2 id=adding-more-frontend-servers>Adding more frontend servers</h2>
<p>The natural response to scaling is to increase the number of frontend
server (Velociraptor <code>frontend servers</code> are those directly connected
with clients). If we can keep the number of clients connected to each
frontend around the 10k limit, and just increase the total number of
servers, we can in theory at least, scale arbitrarily.</p>
<h3 id=storage-requirements>Storage requirements</h3>
<p>Velociraptor collects two distinct classes of data. Internally,
Velociraptor separates access to these two different types depending
on the data latency and bandwidth requirements:</p>
<ol>
<li>
<p><strong>Datastore</strong>: In Velociraptor terminology the data store is used
to store small metadata about various things, such as clients,
flows, collections etc. These are usually encoded in the form of
small JSON files.</p>
</li>
<li>
<p><strong>Filestore</strong>: The Filestore is used to store large, bulk data,
such as collected files or the result sets from running queries on
clients.</p>
</li>
</ol>
<p>The two concepts are separated in Velociraptor because they typically
have much different access patterns:</p>
<ul>
<li>
<p>Datastore items are read and written frequently - for example,
client metadata is checked regularly by all servers. Flow
information is also checked frequently to update its statistics
etc. Typically datastore items are read and written as single JSON
units. Datastore items have typically very small bandwidth
requirements since they are just small JSON encoded, but the data
needs to be synchronized across all frontends.</p>
</li>
<li>
<p>Filestore items are typically written by the server as data is
collected from clients. They are not read very often - typically
only by the GUI or server side VQL queries. Filestore items are very
large (think collected memory images, or event logs) so require
large bandwidth to the storage medium, but latency requirements are
not very strict (as long as the data eventually makes it the storage
this is fine!).</p>
</li>
</ul>
<p>In the single server deployments, we typically use an attached storage
device (usually an SSD storage) to the server and use it to store both
types of data. This works pretty well because SSD storage is very fast
and provides both <strong>high bandwidth</strong> and <strong>very low latency</strong>.</p>
<h3 id=scaling-storage>Scaling storage</h3>
<p>In order to scale storage between multiple servers, we need to use a
<strong>distributed filesystem</strong>, such as NFS or EFS. Typically we use AWS
EFS service although other cloud providers offer a similar service
(e.g. Google Filestore)</p>
<p>Network filesystems are typically mounted on the instance at a
specific <strong>mount point directory</strong>, and appear just like a normal
attached storage, so they can be directly used by Velociraptor by
simply pointing the <code>Datastore.Location</code> configuration parameter at
this mount point.</p>
<p>However, there are some critical key differences between EFS and
attached storage!</p>
<h3 id=high-latency-filesystems>High latency filesystems</h3>
<p>Network filesystems typically exhibit high latency, since each IO
operation involves a network round trip. This inevitably results in
around 40-60ms per read/write operation.</p>
<p>This property degrades operation with distributed servers. For
example, consider the Velociraptor frontend receiving a collection
response from the client:</p>
<ol>
<li>Read the client&rsquo;s public key so we can decrypt the messages.</li>
<li>Read the flow from disk so we know where to store the data</li>
<li>Write the result set to storage</li>
<li>Write the updated flow information to storage.</li>
</ol>
<p>Filesystem latency will add some time to each of these steps,
resulting in a much longer time to serve each client request -
therefore limiting the total number of client requests we can serve in
a given time.</p>
<p>Synchronization across multiple frontends might also be a
problem. Imagine a hunt being run across the deployment. The hunt
statistics record contains information such as total clients
scheduled, total client complete etc. If the record is being
concurrently updated from multiple servers, the record needs to be
locked and filesystem locks are extremely slow in NFS so they must be
avoided at all cost.</p>
<h2 id=velociraptors-multi-server-design>Velociraptor&rsquo;s multi server design</h2>
<p>Currently Velociraptor&rsquo;s multi server design is divided into a
<strong>master</strong> server and one or more <strong>minion</strong> servers. The servers
coordinate work by passing messages using a <strong>replication service</strong>
between minion and master.</p>
<p>
<figure>
<img src=MultiFrontend_design.png alt="Multi Frontend architecture overview" class=captioned>
<figcaption>Multi Frontend architecture overview</figcaption>
</figure>
</p>
<h3 id=the-master-node>The Master node</h3>
<p>The master node runs specific services that coordinate clients. Some
of these service are:</p>
<ol>
<li>
<p>The GUI service only runs on the master node.</p>
</li>
<li>
<p>The <code>Hunt Manager</code> service is responsible for scheduling
collections on clients, keeping track of hunt statistics and
creating new hunts.</p>
</li>
<li>
<p>Datastore - the Master is the only node that reads/writes to the
data store (note - the datastore only stores very small metadata
files). On the master, the datastore is typically cached in memory
and synchronized to the EFS volume asynchronously.</p>
</li>
<li>
<p>Replication service - relays messages from all minions to various
listeners. This is the main mechanism the master uses for
communication with the minions.</p>
</li>
</ol>
<h3 id=the-minion-node>The Minion node</h3>
<p>The minion node is responsible for collecting data from clients:</p>
<ol>
<li>
<p>The minion does not read or write directly from the datastore,
instead it uses a remote procedure call (gRPC) to read from the
master&rsquo;s datastore. This means that the master is the source of
truth for metadata and there is no need to implement additional
cluster wide locking.</p>
</li>
<li>
<p>The minion write bulk data directly to the EFS volume. These write
occur asynchronously Since bulk data is the majority of file IO,
minions are offloading a significant proportion of file IO.</p>
</li>
<li>
<p>Minions are responsible for dispatching work to clients, and
collecting their responses.</p>
</li>
</ol>
<h2 id=strategies-to-address-high-latency>Strategies to address high latency</h2>
<p>Here we describe some of the strategies used to increase performance.</p>
<h3 id=caching>Caching</h3>
<p>To work around a lot of the latency issues, Velociraptor implements
multiple caching mechanisms to ensure file IO is not needed. The
caching allows writes to occur in parallel at a later stage without
holding the client&rsquo;s connection open for too long.</p>
<ul>
<li>
<p>Client key cache - This is required to decrypt messages from
clients. Velociraptor keeps keys in memory to avoid having to read
those from storage for each incoming connection. The size of the
cache is controlled by the <code>Frontend.resources.expected_clients</code>
setting.</p>
</li>
<li>
<p>Search index cache: The client search index is used by the GUI to
search for clients by labels, hostname, IP address etc. From 0.6.3
the search index is completely memory resident, making search
queries very fast.</p>
</li>
<li>
<p>Datastore memory cache - The Master node, caches datastore files in
memory. Much of the time, writes to the datastore are completed
immediately into the memory cache, while the cache is flushed to the
EFS storage asynchronously. This removes the perception of latency
from most datastore operations.</p>
</li>
</ul>
<h1 id=configuration>Configuration</h1>
<p>This section describes how to configure a multi server deployment. We
typically start off with a normal configuration as generated with
<code>velociraptor config generate -i</code>.</p>
<p>
<figure>
<img src=basic_generation.png alt="Generating a basic configuration" class=captioned>
<figcaption>Generating a basic configuration</figcaption>
</figure>
</p>
<p>In the above example I generate a self signed configuration with a
server at <code>master.velocidex-training.com</code>. I will use the dynamic DNS
setting to automatically update the frontend dns mapping.</p>
<p>Now I derive a multi-server configuration from this basic
configuration.</p>
<pre><code class=language-bash>velociraptor --config server.config.yaml config frontend
</code></pre>
<p>
<figure>
<img src=config_frontend.png alt="Generating a multi frontend configuration" class=captioned>
<figcaption>Generating a multi frontend configuration</figcaption>
</figure>
</p>
<p>Let&rsquo;s look at some of the generated configuration. The client
configuration is now changed to include both minion and master:</p>
<pre><code class=language-yaml>Client:
  server_urls:
    - https://master.velocidex-training.com:8000/
    - https://minion.velocidex-training.com:8100/
</code></pre>
<p>This will cause clients to randomly connect to one of the servers.</p>
<p>The API server is now listening on all interfaces and can be accessed
by the public hostname. This is required for minions to connect to the
master.</p>
<pre><code class=language-yaml>API:
  hostname: master.velocidex-training.com
  bind_address: 0.0.0.0
  bind_port: 8001
</code></pre>
<p>There is an additional configuration part for each minion:</p>
<pre><code class=language-yaml>ExtraFrontends:
- hostname: minion.velocidex-training.com
  bind_address: 0.0.0.0
  bind_port: 8100
  dyn_dns:
      ddns_username: ZWLfJ7InGAB1PcoC
      ddns_password: ufNrxN95HKhRjutM
</code></pre>
<p>Finally note the datastore configuration</p>
<pre><code class=language-yaml>Datastore:
  location: /opt/velociraptor
  filestore_directory: /opt/velociraptor
  minion_implementation: RemoteFileDataStore
  master_implementation: MemcacheFileDataStore
</code></pre>
<p>We can see that the master will be running the
<code>MemcacheFileDataStore</code> - a specific implementation of the data store
which stores file in a memory cache while syncing them with the
storage asynchronously.</p>
<p>The minion, on the other hand will connect to the master via the
remote datastore (a gRPC based datastore implementation)..</p>
<h2 id=making-deb-package>Making deb package.</h2>
<p>Now we can create the deb package using the normal method:</p>
<pre><code class=language-yaml>$ ./velociraptor-v0.6.3-rc1-linux-amd64 --config server.config.yaml debian server
$ ls -l *.deb
-rw-rw-r-- 1 mic mic 16347350 Jan  1 06:25 velociraptor_0.6.3-rc1_server_master_master.velocidex-training.com-8000.deb
-rw-rw-r-- 1 mic mic 16347356 Jan  1 06:25 velociraptor_0.6.3-rc1_server_minion_minion.velocidex-training.com-8100.deb
</code></pre>
<p>We expect each of these packages to be deployed on their own virtual
machine instances. Each VM should be built with the same EFS volume
mounted on <code>/opt/velociraptor</code></p>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1645057811></script>
<script src=/js/perfect-scrollbar.min.js?1645057811></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1645057811></script>
<script src=/js/jquery.sticky.js?1645057811></script>
<script src=/js/featherlight.min.js?1645057811></script>
<script src=/js/highlight.min.js?1645057811></script>
<script>hljs.highlightAll()</script>
<script src=/js/modernizr.custom-3.6.0.js?1645057811></script>
<script src=/js/learn.js?1645057811></script>
<script src=/js/hugo-learn.js?1645057811></script>
</body>
</html>