<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.92.0">
<meta name=description content>
<link rel=icon href=/images/favicon.png type=image/png>
<title>Server Monitoring :: Velociraptor - Digging deeper!</title>
<link href=/css/nucleus.css?1642305088 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1642305088 rel=stylesheet>
<link href=/css/featherlight.min.css?1642305088 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1642305088 rel=stylesheet>
<link href=/css/auto-complete.css?1642305088 rel=stylesheet>
<link href=/css/theme.css?1642305088 rel=stylesheet>
<link href=/css/tabs.css?1642305088 rel=stylesheet>
<link href=/css/hugo-theme.css?1642305088 rel=stylesheet>
<link href=/css/theme-mine.css?1642305088 rel=stylesheet>
<link href=/css/dark.css?1642305088 rel=stylesheet><link href=/css/syntax.css?1642305088 rel=stylesheet><link href=/css/light.css?1642305088 rel=stylesheet><link href=/css/hljs.css?1642305088 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1642305088 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1642305088></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYH72LMYCS',{anonymize_ip:!1})}</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYH72LMYCS','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script></script>
</head>
<body data-url=/docs/server_automation/server_monitoring/>
<nav id=sidebar><div id=header-wrapper>
<div id=header>
<script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script>
<div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()>
<i class="fas fa-moon"></i>
</div>
<div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()>
<i class="fas fa-sun"></i>
</div>
<a href=https://docs.velociraptor.app/>
<img src=https://docs.velociraptor.app//images/logo.svg>
</a>
</div>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/announcements/2021-artifact-contest/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2021-artifact-contest/>2021 Contest</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item parent haschildren">
<div>
<i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item parent haschildren">
<div>
<i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class="dd-item parent active">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a>
</div>
</li>
</ul>
</li>
</ul>
</li><hr>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_auscert/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_auscert/>Auscert 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_osdfc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_osdfc/>OSDFC 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_blueteam_village/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_blueteam_village/>BTV 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a>
</div>
</li>
</ul>
<hr>
<section id=shortcuts>
<h3></h3>
<ul>
<li>
<a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a>
</li>
<li>
<a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a>
</li>
<li>
<a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a>
</li>
</ul>
</section>
<section id=footer>
<div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7>
<br> <i class="fas fa-copyright"></i> 2021
</div>
</section>
</div>
</nav>
<script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=top-github-link>
<a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/docs/server_automation/server_monitoring/_index.md target=blank>
<i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span>
</a>
</div>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
Server Monitoring
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#server-monitoring>Server Monitoring</a></li>
<li><a href=#watching-for-new-clients-to-come-online>Watching for new clients to come online</a>
<ul>
<li><a href=#step-1-checking-a-group-of-clients-for-online-status>Step 1: Checking a group of clients for online status</a></li>
<li><a href=#step-2-sending-a-message-to-slack>Step 2: Sending a message to Slack</a></li>
<li><a href=#step-3-putting-it-all-together>Step 3: Putting it all together.</a></li>
<li><a href=#step-4-creating-a-monitoring-artifact>Step 4: Creating a monitoring artifact</a></li>
<li><a href=#step-5-install-the-artifact>Step 5: Install the artifact</a></li>
</ul>
</li>
<li><a href=#alerts-and-escalations>Alerts and escalations</a></li>
<li><a href=#responding-to-client-events>Responding to client events</a>
<ul>
<li><a href=#example---enrich-encoded-powershell-process-execution-logs>Example - enrich encoded powershell process execution logs</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
Server Monitoring
</h1>
<h2 id=server-monitoring>Server Monitoring</h2>
<p>We have previously seen the VQL <a href=/docs/vql/events/>Event Queries</a> are simply VQL queries that never terminate,
generating a row for each event that occurs. We also saw how these
event queries can be used to collect real time telemetry from endpoint
with <a href=/docs/client_monitoring/>Client Monitoring</a>.</p>
<p>In this section we describe how event queries can be used to
monitoring server events and perform real time post processing on
forwarded client events.</p>
<h2 id=watching-for-new-clients-to-come-online>Watching for new clients to come online</h2>
<p>As an example for server monitoring queries, we describe a common use
case:</p>
<ol>
<li>
<p>Check every minute the status of some clients we are interested in
investigating.</p>
</li>
<li>
<p>When a particular client appears online, send a slack message to a
predefined channel.</p>
</li>
</ol>
<p>The full description of how to set up slack to receive messages from
Velociraptor can be found in our blog post <a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and
Velociraptor</a>, but
here we cover the high level details.</p>
<h3 id=step-1-checking-a-group-of-clients-for-online-status>Step 1: Checking a group of clients for online status</h3>
<p>Typically when we want to group clients we use a label. So we will
apply the Slack label to the clients we are interested in coming back
online.</p>
<p>Our query will therefore search for all clients with that label and
compare their last seen time to ensure it is more recent than a few
minutes ago.</p>
<pre><code class=language-vql>LET hits = SELECT client_id,
       os_info.fqdn as Hostname ,
       now() - last_seen_at / 1000000 AS LastSeen,
       label(client_id=client_id, labels=LabelGroup, op=&quot;remove&quot;)
FROM clients(search=&quot;label:&quot; + LabelGroup)
WHERE LastSeen &lt; 300
</code></pre>
<p>Once we report on a client once, we will remove the label from the
client to prevent it from reporting the same client again.</p>
<h3 id=step-2-sending-a-message-to-slack>Step 2: Sending a message to Slack</h3>
<p>To send a message to a slack channel all we need do is to make a HTTP
Post request to the Slack API using a token. The details are described
in the Slack API docs but the below query simply sends a slack message
reporting the client id and hostname of the client that came back
online.</p>
<pre><code class=language-vql>LET send_massage = SELECT * FROM foreach(row=hits,
query={
   SELECT client_id, Hostname, LastSeen, Content, Response
   FROM http_client(
        data=serialize(item=dict(
        text=format(format=&quot;Client %v (%v) has appeared online %v seconds ago&quot;,
                    args=[Hostname, client_id, LastSeen])),
        format=&quot;json&quot;),
    headers=dict(`Content-Type`=&quot;application/json&quot;),
    method=&quot;POST&quot;,
    url=token_url)
})
</code></pre>
<h3 id=step-3-putting-it-all-together>Step 3: Putting it all together.</h3>
<p>So far the previous queries were not event queries. We now simply
perform those queries on a schedule to turn the query into an event
query.</p>
<pre><code class=language-vql>// Check every minute
SELECT * FROM foreach(
   row={SELECT * FROM clock(period=60)},
   query=send_massage)
</code></pre>
<h3 id=step-4-creating-a-monitoring-artifact>Step 4: Creating a monitoring artifact</h3>
<p>Next I package the query into a complete artifact. I go to the “View
Artifacts” sidebar and then click the “Add an artifact” button. Do not
forget to mark the artifact as <code>type: SERVER_EVENT</code></p>
<p>
<figure>
<img src=checking_slack_artifact.png alt="Slack announce clients online" class=captioned>
<figcaption>Slack announce clients online</figcaption>
</figure>
</p>
<p>The two main differences here are that this is a SERVER_EVENT artifact — i.e. it is running on the server continuously. I then use the clock() plugin to trigger the previous query to run every minute and scan for new clients coming online (line 27: <strong>foreach</strong> <strong>clock</strong> event, run the <strong>send_message</strong> query).</p>
<h3 id=step-5-install-the-artifact>Step 5: Install the artifact</h3>
<p>To install the artifact on the server, I will go to the Server Monitoring screen, and add it in the search view by clicking the “update server monitoring table” toolbar button.</p>
<p>
<figure>
<img src=adding_server_event_artifact.png alt="Adding a server event artifact" class=captioned>
<figcaption>Adding a server event artifact</figcaption>
</figure>
</p>
<p>Now I can add the label to any client I am interested in and within a minute of it coming back online I will receive an alert in my slack channel</p>
<p>
<figure>
<img src=slack_alerts.png alt="Receiving slack alerts" class=captioned>
<figcaption>Receiving slack alerts</figcaption>
</figure>
</p>
<h2 id=alerts-and-escalations>Alerts and escalations</h2>
<p>The above example demonstrates how a server event query can automate
response for specific conditions on the server. Once started, the
event query simply monitors the server for a specific condition and
when met, the query automatically escalates by making direct REST API
access to an external system (e.g. Slack). Although the query will
also emit a row (which will be stored on the server), in this case we
are most interested in the side effect of making a REST
call. Similarly we could escalate via a mail (using the <code>mail()</code>
plugin) or push rows to Elastic or Splunk (using the
<code>upload_elastic()</code> or <code>upload_splunk()</code> plugin).</p>
<h2 id=responding-to-client-events>Responding to client events</h2>
<p>I previously described how client event queries can be used to collect
real time telemetry from endpoint with <a href=/docs/client_monitoring/>Client Monitoring</a>. However, we also saw that
Velociraptor simply writes the resulting events to storage. How can we
post process or escalate based on client events that occur on the
endpoint?</p>
<p>Server monitoring artifacts can also be written to respond to client
events using the <code>watch_monitoring()</code> plugin.</p>
<h3 id=example---enrich-encoded-powershell-process-execution-logs>Example - enrich encoded powershell process execution logs</h3>
<p>Powershell is a commonly used offensive tool in the wild. Powershell
has a feature that allows a script to be passed to it using an
obfuscated base64 encoded commandline.</p>
<p>This means that typical process execution logs will display commands such as</p>
<pre><code class=language-sh>powershell -encodedCommand ZABpAHIAIAAiAGMAOgBcAHAAcgBvAGcAcgBhAG0AIABmAGkAbABlAHMAIgAgAA==
</code></pre>
<p>Making it difficult to visually inspect the commandline.</p>
<p>In this example we wish to decode such a command on the server to
present a small subset of decoded powershell command lines.</p>
<div class="mynotices note">
<div heading=note><p>Alternatively we can decode the commandline on the endpoint itself and forward the enriched event (including the decoded command line)</p>
</div>
</div>
<p>Consider the <code>Server.Powershell.EncodedCommand</code> artifact:</p>
<pre><code class=language-vql>SELECT ClientId, ParentInfo, CommandLine, Timestamp, utf16(
   string=base64decode(
      string=parse_string_with_regex(
         string=CommandLine,
         regex='-((?i)(en|enc|encode|encodedCommand)) (?P&lt;Encoded&gt;[^ ]+)'
      ).Encoded)) AS Script
FROM watch_monitoring(artifact='Windows.Events.ProcessCreation')
WHERE CommandLine =~ '-(en|enc|encode|encodedCommand)'
</code></pre>
<p>The artifact watched for any rows returns from the client artifact
<code>Windows.Events.ProcessCreation</code> (originating from any client), and
applies a regular expression filter to the command line to identify
the encoded command lines. The artifact then extract the base64 blob
and decodes it.</p>
<p>Here is a high level overview diagram.</p>
<p>
<figure>
<img src=enriching_client_events.png alt="Enriching Client Events" class=captioned>
<figcaption>Enriching Client Events</figcaption>
</figure>
</p>
<ol>
<li>
<p>First we configure Velociraptor to collect the
<code>Windows.Events.ProcessCreation</code> from all clients (using the Client
Events configuration screen). These events will be collected from
all clients and written to the server.</p>
</li>
<li>
<p>Next we configure a server artifact (from the <code>Server Events</code>
screen) to monitor all client events and identify the encoded
powershell commands.</p>
</li>
<li>
<p>The encoded PowerShell commands will be generated as rows from the
<code>Server.Powershell.EncodedCommand</code> server artifact.</p>
</li>
</ol>
<p>Now we are able to decode encoded powershell command lines</p>
<p>
<figure>
<img src=decoded_powershell.png alt="Decoding powershell commands" class=captioned>
<figcaption>Decoding powershell commands</figcaption>
</figure>
</p>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1642305088></script>
<script src=/js/perfect-scrollbar.min.js?1642305088></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1642305088></script>
<script src=/js/jquery.sticky.js?1642305088></script>
<script src=/js/featherlight.min.js?1642305088></script>
<script src=/js/highlight.min.js?1642305088></script>
<script>hljs.highlightAll()</script>
<script src=/js/modernizr.custom-3.6.0.js?1642305088></script>
<script src=/js/learn.js?1642305088></script>
<script src=/js/hugo-learn.js?1642305088></script>
</body>
</html>