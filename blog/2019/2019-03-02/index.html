<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.88.1">
<meta name=description content="There has been a lot of interest lately in &#34;Agentless hunting&#34;
especially using PowerShell.  This blog post explores an agentless
deployment scenario, where we do not want to install Velociraptor
permanently on the end point, but rather push it to end points
temporarily to collect specific artifacts.
">
<link rel=icon href=/images/favicon.png type=image/png>
<title>Agentless hunting with Velociraptor :: Velociraptor - Digging deeper!</title>
<link href=/css/nucleus.css?1631749585 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1631749585 rel=stylesheet>
<link href=/css/featherlight.min.css?1631749585 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1631749585 rel=stylesheet>
<link href=/css/auto-complete.css?1631749585 rel=stylesheet>
<link href=/css/theme.css?1631749585 rel=stylesheet>
<link href=/css/tabs.css?1631749585 rel=stylesheet>
<link href=/css/hugo-theme.css?1631749585 rel=stylesheet>
<link href=/css/theme-mine.css?1631749585 rel=stylesheet>
<link href=/css/dark.css?1631749585 rel=stylesheet><link href=/css/syntax.css?1631749585 rel=stylesheet><link href=/css/light.css?1631749585 rel=stylesheet><link href=/css/hljs.css?1631749585 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1631749585 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1631749585></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYH72LMYCS',{anonymize_ip:!1})}</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYH72LMYCS','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script></script>
</head>
<body data-url=/blog/2019/2019-03-02/>
<nav id=sidebar><div id=header-wrapper>
<div id=header>
<script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script>
<div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()>
<i class="fas fa-moon"></i>
</div>
<div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()>
<i class="fas fa-sun"></i>
</div>
<a href=https://docs.velociraptor.app/>
<img src=https://docs.velociraptor.app//images/logo.svg>
</a>
</div>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/announcements/2021-artifact-contest/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2021-artifact-contest/>2021 Contest</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a>
</div>
</li>
</ul>
</li><hr>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a>
</div>
</li>
</ul>
<hr>
<section id=shortcuts>
<h3></h3>
<ul>
<li>
<a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a>
</li>
<li>
<a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a>
</li>
<li>
<a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a>
</li>
</ul>
</section>
<section id=footer>
<div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7>
<br> <i class="fas fa-copyright"></i> 2021
</div>
</section>
</div>
</nav>
<script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=top-github-link>
<a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/blog/2019/2019-03-02/_index.md target=blank>
<i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span>
</a>
</div>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
Agentless hunting with Velociraptor
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#creating-a-network-share>Creating a network share</a></li>
<li><a href=#creating-the-group-policy-object>Creating the group policy object.</a></li>
<li><a href=#persistence>Persistence</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
Agentless hunting with Velociraptor
</h1>
<div class="author pull-right">
<span class=date>2019-03-02</span>
</div>
<p>There has been a lot of interest lately in Agentless hunting especially
using PowerShell. There are many reasons why Agentless hunting is
appealing - there are already a ton of endpoint agents and yet another
one may not be welcome. Somtimes we need to deploy endpoint agents as
part of a DFIR engagement and we may not want to permanently install yet
another agent on end points.</p>
<p>This blog post explores an agentless deployment scenario, where we do
not want to install Velociraptor permanently on the end point, but
rather push it to end points temporarily to collect specific artifacts.
The advantage of this method is that there are no permanent changes to
the end point, as nothing is actually installed. However, we do get the
full power of Velociraptor to collect artifacts, hunt for evil and
more...</p>
<h1 id=agentless-velociraptor>Agentless Velociraptor</h1>
<p>Normally when deploying Velociraptor as a service, the binary is copied
to the system and a service is installed. The service ensures that the
binary is restarted when the system reboots, and so Velociraptor is
installed on a permanent basis.</p>
<p>However in the agentless deployment scenario we simply run the binary
from a network share using group policy settings. The downside to this
approach is that the endpoint needs to be on the domain network to
receive the group policy update (and have the network share accessible)
before it can run Velociraptor. When we run in Agentless mode we are
really after collecting a bunch of artifacts via hunts and then exiting</p>
<ul>
<li>the agent will not restart after a reboot. So this method is suitable
for quick hunts on corporate (non roaming) assets.</li>
</ul>
<p>In this post I will use Windows 2019 Server but this should also work on
any older version.</p>
<h2 id=creating-a-network-share>Creating a network share</h2>
<p>The first step is to create a network share with the Velociraptor binary
and its configuration file. We will run the binary from the share in
this example, but for more reliability you may want to copy the binary
into e.g. a temp folder on the end point in case the system becomes
disconnected from the domain. For quick hunts though it should be fine.</p>
<p>We create a directory on the server (I will create it on the domain
controller but you should probably not do that - find another machine to
host the share).</p>
<p>
<figure>
<img src=1.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<p>I created a directory C:\\Users\\Deployment and ensured that it is
read only. I have shared the directory as the name Deployment.</p>
<p>I now place the Velociraptor executable and client config file in that
directory and verify that I can run the binary from the network share.
The binary should be accessible via
`\\\\DC\Deployment\velociraptor.exe`:</p>
<p>
<figure>
<img src=2.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<h2 id=creating-the-group-policy-object>Creating the group policy object.</h2>
<p>Next we create the group policy object which forces all domain connected
machines to run the Velociraptor client. We use the Group Policy
Management Console:</p>
<p>
<figure>
<img src=3.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<p>Select the OU or the entire domain and click "Create New GPO":</p>
<p>
<figure>
<img src=4.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<p>Now right click the GPO object and select "Edit":</p>
<p>
<figure>
<img src=5.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<p>We will create a new scheduled task. Rather than schedule it at a
particular time, we will select to run it immediately. This will force
the command to run as soon as the endpoint updates its group policy
settings (i.e. we do not want to wait for the next reboot of the
endpoint).</p>
<p>
<figure>
<img src=6.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<p>Next we give the task a name and a description. In order to allow
Velociraptor to access raw devices (e.g. to collect memory or NTFS
artifacts) we can specify that the client will run at
NT_AUTHORITY\\SYSTEM privileges, and run without any user being
logged on. It is also worth ticking the "hidden" checkbox here to
prevent a console box from appearing.</p>
<p>
<figure>
<img src=7.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<p>Next click the Actions tab and add a new action. This is where we launch
the Velociraptor client. The program will simply be launched from the
share (i.e. \\\\\\\\DC\\Deployment\\velociraptor.exe) and we
give it the arguments allowing it to read the provided configuration
file (i.e.
--config \\\\\\\\DC\\Deployment\\client.config.yaml client -v).</p>
<p>
<figure>
<img src=8.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<p>In the setting tab we can control how long we want the client to run.
For a quick hunt this may be an hour or two but maybe for a DFIR
engagement it might be a few days. The GPO will ensure the client is
killed after the allotted time.</p>
<p>
<figure>
<img src=9.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<p>Once the GPO is installed it becomes active for all domain machines. You
can now schedule any hunts you wish using the Velociraptor GUI. When a
domain machine refreshes its group policy it will run the client, which
will enroll and immediately participate in any outstanding hunts - thus
collecting and delivering its artifacts to the server. After the
allotted time has passed, the client will shut down without having
installed anything on the endpoint.</p>
<p>You can force a group policy update by running the gpupdate program. Now
you can verify that Velociraptor is running:</p>
<p>
<figure>
<img src=10.png alt=image class=captioned>
<figcaption>image</figcaption>
</figure>
</p>
<h2 id=persistence>Persistence</h2>
<p>Note that when running Velociraptor in agent less mode you probably want
to configure it so that the writeback file is written to the temp
directory. The writeback file is how the client keeps track of its key
material (and identity). The default is to store it in the client's
installation folder, but you should probably change it in the client's
config file:</p>
<pre><code class=language-{.sourceCode>Client:
  writeback_windows: $TEMP\\velociraptor.writeback.yaml
</code></pre>
<p>The file will remain in the client's temp directory so if you ever
decide to run the agentless client again (by pushing another group
policy) the client id remains the same.</p>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1631749585></script>
<script src=/js/perfect-scrollbar.min.js?1631749585></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1631749585></script>
<script src=/js/jquery.sticky.js?1631749585></script>
<script src=/js/featherlight.min.js?1631749585></script>
<script src=/js/highlight.min.js?1631749585></script>
<script>hljs.highlightAll()</script>
<script src=/js/modernizr.custom-3.6.0.js?1631749585></script>
<script src=/js/learn.js?1631749585></script>
<script src=/js/hugo-learn.js?1631749585></script>
</body>
</html>