<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.88.1">
<meta name=description content="We have previously shown how the Velociraptor API provides a
powerful mechanism to integrate and automate. In this post we
demonstrate an example of a program which takes advantage of the API
to present the client's VFS as a FUSE filesystem.
">
<link rel=icon href=/images/favicon.png type=image/png>
<title>The Velociraptor API and FUSE :: Velociraptor - Digging deeper!</title>
<link href=/css/nucleus.css?1631791346 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1631791346 rel=stylesheet>
<link href=/css/featherlight.min.css?1631791346 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1631791346 rel=stylesheet>
<link href=/css/auto-complete.css?1631791346 rel=stylesheet>
<link href=/css/theme.css?1631791346 rel=stylesheet>
<link href=/css/tabs.css?1631791346 rel=stylesheet>
<link href=/css/hugo-theme.css?1631791346 rel=stylesheet>
<link href=/css/theme-mine.css?1631791346 rel=stylesheet>
<link href=/css/dark.css?1631791346 rel=stylesheet><link href=/css/syntax.css?1631791346 rel=stylesheet><link href=/css/light.css?1631791346 rel=stylesheet><link href=/css/hljs.css?1631791346 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1631791346 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1631791346></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYH72LMYCS',{anonymize_ip:!1})}</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYH72LMYCS','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script></script>
</head>
<body data-url=/blog/html/2019/08/28/the_velociraptor_api/>
<nav id=sidebar><div id=header-wrapper>
<div id=header>
<script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script>
<div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()>
<i class="fas fa-moon"></i>
</div>
<div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()>
<i class="fas fa-sun"></i>
</div>
<a href=https://docs.velociraptor.app/>
<img src=https://docs.velociraptor.app//images/logo.svg>
</a>
</div>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/announcements/2021-artifact-contest/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2021-artifact-contest/>2021 Contest</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a>
</div>
</li>
</ul>
</li><hr>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a>
</div>
</li>
</ul>
<hr>
<section id=shortcuts>
<h3></h3>
<ul>
<li>
<a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a>
</li>
<li>
<a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a>
</li>
<li>
<a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a>
</li>
</ul>
</section>
<section id=footer>
<div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7>
<br> <i class="fas fa-copyright"></i> 2021
</div>
</section>
</div>
</nav>
<script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=top-github-link>
<a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/blog/html/2019/08/28/the_velociraptor_api.md target=blank>
<i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span>
</a>
</div>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
The Velociraptor API and FUSE
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#overview>Overview</a>
<ul>
<li><a href=#running-the-fuse-program>Running the FUSE program</a></li>
</ul>
</li>
<li><a href=#conclusions>Conclusions</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
The Velociraptor API and FUSE
</h1>
<div class="author pull-right">
<span class=date>2019-08-26</span>
</div>
<div class="mynotices warning">
<div heading=warning><p>This page is written about a very old version of Velociraptor and is
retained for historical purposes. Currently the fuse feature was removed.</p>
</div>
</div>
<p>The Velociraptor GUI is very useful, but for the power user, the
Velociraptor API provides a powerful mechanism to integrate and
automate. We previously discussed how the Velociraptor API can be used
by external programs. This post explore a sample program that uses the
API and presents a client&rsquo;s VFS as a FUSE directory.</p>
<p>This allows us to navigate the remote end point&rsquo;s file system as if it
was mounted locally - we can list directories or fetch files, or even
open remote files using third party programs. All the while, these
actions are fully audited on the server and the collected files are
stored in Velociraptor&rsquo;s file store for archiving and evidence
preservation.</p>
<h2 id=overview>Overview</h2>
<p>Consider an analyst investigating an end point. The analyst has some
third party tools on their workstation which they would like to use on
files obtained from the end point.</p>
<p>Filesystem in Usespace (FUSE) is a way of creating the illusion of a
real filesystem using software. When various programs on the computer
requests filesystem operations, such as listing files in a directory
or reading a file, Velociraptor takes over and emulates these
requests.</p>
<p>Velociraptor&rsquo;s built in FUSE program emulates a filesystem by
exporting a client&rsquo;s cached VFS on the server to the FUSE layer. If
the analyst attempts to list a directory that the server has no cache
of - the server will issue a new directory listing request from the
endpoint. If the endpoint is currently online, the updated directory
listing will be returned to the server, and in turn relayed to the
analyst&rsquo;s workstation.</p>
<p>The overall effect is that as the analyst navigates around the FUSE
filesystem on their workstation, they are issuing collection requests
from the endpoint, and reading their responses in such as way that it
appears the endpoint is really mounted on the FUSE filesystem.</p>
<p>![Image](../Fuse overview.png)</p>
<p>The above figure shows all the components and how they are
related. Assume the FUSE filesystem is mounted on drive <code>Q:</code> in the
analyst&rsquo;s workstation:</p>
<ol>
<li>
<p>Suppose the analyst is navigating the file <code>Q:\file\</code> using Windows
Explorer.</p>
</li>
<li>
<p>Velociraptor&rsquo;s FUSE program running on the analyst workstation will
issue an API request to list the <code>file</code> directory within the
client&rsquo;s VFS on the server.</p>
</li>
<li>
<p>If the server has a locally cached version of this VFS directory in
its data store it will return it immediately.</p>
</li>
<li>
<p>However, if no server side cache exists, the FUSE program will
issue a directory listing request to the endpoint.</p>
</li>
<li>
<p>The endpoint will respond to this and return the directory listing
(if it is currently online).</p>
</li>
<li>
<p>Now the server will contain a cached copy of the VFS directory and
can return it (just as in step 3 above).</p>
</li>
<li>
<p>The Velociraptor FUSE program on the workstation can return the
directory listing to the Windows kernel and this will be fed back
into the Windows Explorer. The end result is that Windows Explorer
appears to be navigating the endpoint&rsquo;s filesystem directly.</p>
</li>
</ol>
<p>You can see this process in the screenshot below:</p>
<p>
<figure>
<img src=../fuse.png alt=Image class=captioned>
<figcaption>Image</figcaption>
</figure>
</p>
<div class="mynotices tip">
<div heading=tip><p>Do not run the fuse API command as a different user to what is
currently logged in (e.g. do not run as Administrator). If you do then
you will not be able to see the FUSE drive in your user&rsquo;s desktop
session.</p>
<p>For example if you are logged in as user &ldquo;Test&rdquo;, then any FUSE drives
created by Velociraptor running as user Test are only visible to user
Test. If you run the above command as an elevated UAC prompt then user
Test will be unable to see the new drive.</p>
</div>
</div>
<h3 id=running-the-fuse-program>Running the FUSE program</h3>
<p>On Windows filesystem in userspace is implemented by the <code>WinFSP</code>
project. You will need to
<a href=http://www.secfs.net/winfsp/download/>download</a> and install it
first.</p>
<p>We require an API key to use the fuse feature so generate one first on
the server:</p>
<pre><code>   $ velociraptor --config server.config.yaml \
        config api_client --name FUSE &gt; api_client.yaml
</code></pre>
<p>Now simply copy the generate <code>api_client.yaml</code> file to the analyst&rsquo;s
workstation. You can mount any client&rsquo;s VFS by simply specifying its
client id and a drive letter to access it:</p>
<pre><code>C:\Program Files\Velociraptor&gt;Velociraptor.exe --api_config f:\api_client.yaml -v fuse q: C.8b6623b1d7c42adf
The service Velociraptor has been started.
[INFO] 2019-08-26T14:12:28Z Initiating VFSRefreshDirectory for /file/C:/Go/ (aff4:/clients/C.8b6623b1d7c42adf/flows/F.BLHUHJ0RDGCRU)
[INFO] 2019-08-26T14:12:28Z Flow for /file/C:/Go/ still outstanding (aff4:/clients/C.8b6623b1d7c42adf/flows/F.BLHUHJ0RDGCRU)
...
</code></pre>
<p>Simply press Ctrl-C to stop the FUSE program as any time.</p>
<h2 id=conclusions>Conclusions</h2>
<p>The FUSE feature is a perfect example of a useful API program. The
program fully automates the Velociraptor server - it received cached
information about the client&rsquo;s VFS status, and then automatically
issues new collection requests as needed.</p>
<p>This kind of automated control of the Velociraptor server opens the
door to many such applications. From automated response to
remediation and automated evidence collection.</p>
<div class="mynotices note">
<div heading=note><p>Some users has asked us what the difference between the FUSE program
and other tools, e.g. F-Response which also create the illusion that
the remote system is mounted on the analyst&rsquo;s workstation. The main
difference is that Velociraptor does not export the <em>raw block device</em>
from the endpoint - it simply exports the files and directories we
collected already. So for example, it is not possible to run a low
level disk analysis system (such as X-Ways) on the mounted FUSE
drive. However you can still run specialized file parsers (such as
Kape or log2timeline) as long as they do not require access to the raw
devices.</p>
</div>
</div>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1631791346></script>
<script src=/js/perfect-scrollbar.min.js?1631791346></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1631791346></script>
<script src=/js/jquery.sticky.js?1631791346></script>
<script src=/js/featherlight.min.js?1631791346></script>
<script src=/js/highlight.min.js?1631791346></script>
<script>hljs.highlightAll()</script>
<script src=/js/modernizr.custom-3.6.0.js?1631791346></script>
<script src=/js/learn.js?1631791346></script>
<script src=/js/hugo-learn.js?1631791346></script>
</body>
</html>