<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.107.0"><meta name=description content="It is also possible to run VQL
queries on the server side! Similarly server side Velociraptor
artifacts can be used to customize the operation of the server -
without modifying any code or redeploying the server components.
"><link rel=icon href=/images/favicon.png type=image/png><title>Server side VQL queries and Escalation Events :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1669416354 rel=stylesheet><link href=/css/fontawesome-all.min.css?1669416354 rel=stylesheet><link href=/css/featherlight.min.css?1669416354 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1669416354 rel=stylesheet><link href=/css/auto-complete.css?1669416354 rel=stylesheet><link href=/css/theme.css?1669416354 rel=stylesheet><link href=/css/tabs.css?1669416354 rel=stylesheet><link href=/css/hugo-theme.css?1669416354 rel=stylesheet><link href=/css/theme-mine.css?1669416354 rel=stylesheet><link href=/css/dark.css?1669416354 rel=stylesheet><link href=/css/syntax.css?1669416354 rel=stylesheet><link href=/css/light.css?1669416354 rel=stylesheet><link href=/css/hljs.css?1669416354 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1669416354 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1669416354></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYH72LMYCS",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-QYH72LMYCS","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script></script></head><body data-url=/blog/html/2018/12/10/server_side_vql_queries_and_events/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp("theme=darkmode");regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/references/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/references/>Config Reference</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a></div></li></ul></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a></div><ul><li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_auscert/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_auscert/>Auscert 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_us/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_us/>DFRWS US 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_tech_user_group_cbr/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_tech_user_group_cbr/>Tech Users Group 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_sans_summit/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_sans_summit/>SANS Summit 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_velocon/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_velocon/>Velocon 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_apac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_apac/>DFRWS APAC 2022</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/artifact_references/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/artifact_references/><i class="fas fa-book"></i>Artifact Reference</a></div></li><li data-nav-id=https://docs.velociraptor.app/knowledge_base/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/knowledge_base/><i class="fas fa-brain"></i>Knowledge Base</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class='fas fa-search'></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class='fab fa-github'></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class='fab fa-discord'></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class='fas fa-envelope'></i>Mailing List</a></li><li><a class=padding href=https://docs.velociraptor.app/rss/><i class='fas fa-rss'></i>RSS</a></li></ul></section><section id=footer><div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2022</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title='Edit this page' href=https://github.com/Velocidex/velociraptor-docs/edit/master/content/blog/html/2018/12/10/server_side_vql_queries_and_events/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Server side VQL queries and Escalation Events</span></div><div class=progress><div class=wrapper><nav id=TableOfContents></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Server side VQL queries and Escalation Events</h1><p>Previously we have seen how Velociraptor collects information from end
points using Velociraptor artifacts. These artifacts encapsulate user
created queries using the Velociraptor Query Language (VQL). The power
of VQL is that it provides for a very flexible way of specifying exactly
what should be collected from the client and how - without needing to
modify client code or deploy new clients!</p><p>This is not the whole story though! It is also possible to run VQL
queries on the server side! Similarly server side Velociraptor artifacts
can be used to customize the operation of the server -without modifying
any code or redeploying the server components.</p><h1 id=server-side-vql-queries>Server Side VQL Queries.</h1><p>By now you are probably familiar with Velociraptor and VQL. We have seen
that it is possible to run a VQL query interactively from the
commandline. For example to find all processes matching the 'gimp':</p><pre><code class=language-{.sourceCode>$ velociraptor query \
   &quot;SELECT Pid, Exe, Cmdline FROM pslist() WHERE Exe =~ 'gimp'&quot;
[
 {
  &quot;Cmdline&quot;: &quot;gimp-2.10&quot;,
  &quot;Exe&quot;: &quot;/usr/bin/gimp-2.10&quot;,
  &quot;Pid&quot;: 13207
 }
]
</code></pre><p>We have used this feature previously in order to perfect and test our
queries by interactively building the query as we go along.</p><p>However it is also possible to run queries on the server itself in order
to collect information about the server. There is nothing special about
this as such - it is simply that some VQL plugins are able to operate on
the server's internal data store and therefore provide a way to
interact with the server via VQL queries.</p><p>::: {.note}
::: {.admonition-title}
Note
:::</p><p>Other endpoint monitoring tools export a rich API and even an API client
library to enable users to customize and control their installation. For
example, GRR expects users write python scripts using the GRR client API
library.</p><p>Velociraptor's approach is different - the functionality typically
available via APIs is made available to VQL queries via VQL plugins
(e.g. client information, flow information and results collected). In
this way the VQL itself forms an API with which one controls the server
and deployment. There is no need to write any code - simply use existing
VQL plugins in any combination that makes sense to create new
functionality - then encapsulates these queries inside Velociraptor
artifacts for reuse and sharing.
:::</p><p>For example, to see all the clients and their hostnames:</p><pre><code class=language-{.sourceCode>$ velociraptor query \
   &quot;SELECT os_info.fqdn as Hostname, client_id from clients()&quot; --format text
+-----------------+--------------------+
|    Hostname     |     client_id      |
+-----------------+--------------------+
| mic-Inspiron    | C.772d16449719317f |
| TestComputer    | C.11a3013cca8f826e |
| trek            | C.952156a4b022ddee |
| DESKTOP-IOME2K5 | C.c916a7e445eb0868 |
+-----------------+--------------------+
SELECT os_info.fqdn AS Hostname,
client_id FROM clients()
</code></pre><p>To inspect what flows were run on a client:</p><pre><code class=language-{.sourceCode>$ velociraptor query \
   &quot;SELECT runner_args.creator, runner_args.flow_name, \
    runner_args.start_time FROM \
    flows(client_id='C.772d16449719317f')&quot;
[
{
  &quot;runner_args.creator&quot;: &quot;&quot;,
  &quot;runner_args.flow_name&quot;: &quot;MonitoringFlow&quot;,
  &quot;runner_args.start_time&quot;: 1544338661236625
},
{
  &quot;runner_args.creator&quot;: &quot;mic&quot;,
  &quot;runner_args.flow_name&quot;: &quot;VFSDownloadFile&quot;,
  &quot;runner_args.start_time&quot;: 1544087705756469
},
...
</code></pre><h1 id=client-event-monitoring>Client Event Monitoring</h1><p>We have also previously seen that Velociraptor can collect event streams
from clients. For example, the client's process execution logs can be
streamed to the server. Clients can also receive event queries which
forward selected events from the windows event logs.</p><p>When we covered those features in earlier blog posts, we stressed that
the Velociraptor server does not actually do anything with the client
events, other than save them to a file. The server just writes the
client's events in simple Comma Separated files (CSV files) on the
server.</p><p>We mentioned that it is possible to import this file into another tool
(e.g. a spreadsheet or database) for post-processing. An alternative is
to perform post-processing with Velociraptor itself using server side
VQL queries.</p><p>For example, we can filter a client's process execution log using a VQL
query:</p><pre><code class=language-{.sourceCode>$ velociraptor query &quot;SELECT * from monitoring(
      client_id='C.87b19dba006fcddb',
      artifact='Windows.Events.ProcessCreation')
    WHERE Name =~ '(?i)psexesvc' &quot;
[
 {
  &quot;CommandLine&quot;: &quot;\&quot;C:\\\\Windows\\\\PSEXESVC.exe\&quot;&quot;,
  &quot;Name&quot;: &quot;\&quot;PSEXESVC.exe\&quot;&quot;,
  &quot;PID&quot;: &quot;452&quot;,
  &quot;PPID&quot;: &quot;512&quot;,
  &quot;Timestamp&quot;: &quot;\&quot;2018-12-09T23:30:42-08:00\&quot;&quot;,
  &quot;artifact&quot;: &quot;Windows.Events.ProcessCreation&quot;,
  &quot;client_id&quot;: &quot;C.87b19dba006fcddb&quot;
 }
]
</code></pre><p>The above query finds running instances of psexec's service component -
a popular method of lateral movement and privilege escalation.</p><p>This query uses the monitoring() VQL plugin which opens each of the CSV
event monitoring logs for the specified artifact on the server, decodes
the CSV file and emits all the rows within it into the VQL Query. The
rows are then filtered by applying the regular expression to the name.</p><h1 id=server-side-event-queries>Server side event queries</h1><p>VQL queries do not have to terminate at all. Some VQL plugins can run
indefinitely, emitting rows at random times - usually in response to
some events. These are called Event Queries since they never terminate.
We saw this property when monitoring the client - the above
Windows.Events.ProcessCreation artifact uses an event query which emits
a single row for each process execution on the end point.</p><p>However, we can also have Event Queries on the server. When used in this
way the query triggers in response to data collected by the server of
various clients.</p><p>For example, consider the above query to detect instances of psexec
executions. While we can detect this by filtering existing monitoring
event logs, it would be nice to be able to respond to such an event
dynamically.</p><p>One way is to repeatedly run the same query (say every minute) and look
for newly reported instances of psexec executions. But this approach is
not terribly efficient. A better approach is to install a watcher on the
monitoring event log:</p><pre><code class=language-{.sourceCode>$ velociraptor query &quot;SELECT * from watch_monitoring(
     client_id='C.87b19dba006fcddb',
     artifact='Windows.Events.ProcessCreation') where Name =~ '(?i)psexesvc' &quot;
[
 {
  &quot;CommandLine&quot;: &quot;\&quot;C:\\\\Windows\\\\PSEXESVC.exe\&quot;&quot;,
  &quot;Name&quot;: &quot;\&quot;PSEXESVC.exe\&quot;&quot;,
  &quot;PID&quot;: &quot;4592&quot;,
  &quot;PPID&quot;: &quot;512&quot;,
  &quot;Timestamp&quot;: &quot;\&quot;2018-12-10T01:18:06-08:00\&quot;&quot;,
  &quot;artifact&quot;: &quot;Windows.Events.ProcessCreation&quot;,
  &quot;client_id&quot;: &quot;C.87b19dba006fcddb&quot;
 }
]
</code></pre><p>The watcher efficiently follows the monitoring CSV file to detect new
events. These events are then emitted into the VQL query and
subsequently filtered. When the query processes all rows in the file,
the plugin just sleeps and waits for the file to grow again. The
watch_monitoring() plugin essentially tails the CSV file as it is being
written. Note that due to the fact that log files are never truncated
and always grow, and that CSV file format is a simple, one row per line
format it is possible to both read and write to the same file without
locking. This makes following a growing log file extremely efficient and
safe - even from another process.</p><h1 id=responding-to-server-side-events>Responding to server side events</h1><p>The previous query will return a row when psexec is run on the client.
This is a very suspicious event in our environment and we would like to
escalate this by sending us an email.</p><p>We can modify the above query to send an email for each event:</p><pre><code class=language-{.sourceCode>SELECT * FROM foreach(
   row={
     SELECT * from watch_monitoring(
       client_id='C.87b19dba006fcddb',
       artifact='Windows.Events.ProcessCreation')
    WHERE Name =~ '(?i)psexesvc'
   },
   query={
     SELECT * FROM mail(
       to='admin@example.com',
       subject='PsExec launched on host',
       period=60,
       body=format(format='PsExec execution detected at %v: %v',
                   args=[Timestamp, Commandline])
     )
   })
</code></pre><p>The query sends an email from each event emitted. The message body is
formatted using the format() VQL function and this includes important
information from the generated event. Note that the mail() plugin
restricts the frequency of mails to prevent triggering the mail
server's spam filters. So if two psexec executions occur within 60
seconds we will only get one email.</p><p>In order for Velociraptor to be able to send mail you must configure
SMTP parameters in the server's configuration file. The following
example uses gmail to send mails (other mail providers will have similar
authentication requirements).</p><pre><code class=language-{.sourceCode>Mail:
  server: &quot;smtp.gmail.com&quot;
  auth_username: someuser@gmail.com
  auth_password: zldifhjsdflkjfsdlie
</code></pre><p>The password in the configuration is an application specific password
obtained from
<a href=https://security.google.com/settings/security/apppasswords>https://security.google.com/settings/security/apppasswords</a></p><p><figure><img src=app_password.png alt=image class=captioned><figcaption>image</figcaption></figure></p><h1 id=tying-it-all-together-server-side-event-artifacts>Tying it all together: Server Side Event Artifacts</h1><p>As always we really want to encapsulate VQL queries in artifact
definitions. This way we can design specific alerts, document them and
invoke them by name. Let us encapsulate the above queries in a new
artifact:</p><pre><code class=language-{.sourceCode>name: Server.Alerts.PsExec
description:  |
   Send an email if execution of the psexec service was detected on any client.

   Note this requires that the Windows.Event.ProcessCreation
   monitoring artifact be collected.

parameters:
  - name: EmailAddress
    default: admin@example.com
  - name: MessageTemplate
    default: |
      PsExec execution detected at %v: %v for client %v

sources:
  - queries:
     - |
       SELECT * FROM foreach(
         row={
           SELECT * from watch_monitoring(
             artifact='Windows.Events.ProcessCreation')
           WHERE Name =~ '(?i)psexesvc'
         },
         query={
           SELECT * FROM mail(
             to=EmailAddress,
             subject='PsExec launched on host',
             period=60,
             body=format(
               format=MessageTemplate,
               args=[Timestamp, CommandLine, ClientId])
          )
       })
</code></pre><p>We create a new directory called my_artifact_directory and store that
file inside as psexesvc.yaml. Now, on the server we invoke the artifact
collector and instruct it to also add our private artifacts:</p><pre><code class=language-{.sourceCode>$ velociraptor --definitions my_artifact_directory/ \
    --config ~/server.config.yaml \
    --format json \
    artifacts collect Server.Alerts.PsExec
INFO:2018/12/10 21:36:27 Loaded 40 built in artifacts
INFO:2018/12/10 21:36:27 Loading artifacts my_artifact_directory/
[][
 {
  &quot;To&quot;: [
    &quot;admin@example.com&quot;
  ],
  &quot;CC&quot;: null,
  &quot;Subject&quot;: &quot;PsExec launched on host&quot;,
  &quot;Body&quot;: &quot;PsExec execution detected at \&quot;2018-12-10T03:36:49-08:00\&quot;: \&quot;C:\\\\Windows\\\\PSEXESVC.exe\&quot;&quot;,
  &quot;Period&quot;: 60
 }
]
</code></pre><h1 id=conclusions>Conclusions</h1><p>This blog post demonstrates how VQL can be used on the server to create
a full featured incident response framework. Velociraptor does not
dictate a particular workflow, since all its actions are governed by VQL
queries and artifacts. Using the same basic building blocks, users can
fashion their own highly customized incident response workflow. Here is
a brainstorm of possible actions:</p><ol><li>An artifact can be written to automatically collect a memory capture
if a certain event is detected.</li><li>Using the http_client() VQL plugin, when certain events are
detected on the server open a ticket automatically (using a SOAP or
JSON API).</li><li>If a particular event is detected, immediately shut the machine down
or quarantine it (by running shell commands on the compromised
host).</li></ol><p>The possibilities are truly endless. Comment below if you have more
interesting ideas and do not hesitate to contribute artifact definitions
to address your real world use cases.</p><footer class=footline></footer></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//velocidex-velociraptor.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1669416354></script>
<script src=/js/perfect-scrollbar.min.js?1669416354></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1669416354></script>
<script src=/js/jquery.sticky.js?1669416354></script>
<script src=/js/featherlight.min.js?1669416354></script>
<script src=/js/highlight.min.js?1669416354></script>
<script>hljs.highlightAll()</script><script src=/js/modernizr.custom-3.6.0.js?1669416354></script>
<script src=/js/learn.js?1669416354></script>
<script src=/js/hugo-learn.js?1669416354></script></body></html>