<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.92.2">
<meta name=description content="This post introduces ETW as an event source and examines how VQL can be used to harness the power of ETW.
">
<link rel=icon href=/images/favicon.png type=image/png>
<title>Event Tracing for Windows Part 1 :: Velociraptor - Digging deeper!</title>
<link href=/css/nucleus.css?1645356557 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1645356557 rel=stylesheet>
<link href=/css/featherlight.min.css?1645356557 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1645356557 rel=stylesheet>
<link href=/css/auto-complete.css?1645356557 rel=stylesheet>
<link href=/css/theme.css?1645356557 rel=stylesheet>
<link href=/css/tabs.css?1645356557 rel=stylesheet>
<link href=/css/hugo-theme.css?1645356557 rel=stylesheet>
<link href=/css/theme-mine.css?1645356557 rel=stylesheet>
<link href=/css/dark.css?1645356557 rel=stylesheet><link href=/css/syntax.css?1645356557 rel=stylesheet><link href=/css/light.css?1645356557 rel=stylesheet><link href=/css/hljs.css?1645356557 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1645356557 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1645356557></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYH72LMYCS',{anonymize_ip:!1})}</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYH72LMYCS','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script></script>
</head>
<body data-url=/blog/2021/2021-08-18-velociraptor-and-etw/>
<nav id=sidebar><div id=header-wrapper>
<div id=header>
<script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script>
<div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()>
<i class="fas fa-moon"></i>
</div>
<div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()>
<i class="fas fa-sun"></i>
</div>
<a href=https://docs.velociraptor.app/>
<img src=https://docs.velociraptor.app//images/logo.svg>
</a>
</div>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/announcements/2021-artifact-contest/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2021-artifact-contest/>2021 Contest</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a>
</div>
</li>
</ul>
</li>
</ul>
</li><hr>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren">
<div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a>
</div>
<ul>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_auscert/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_auscert/>Auscert 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_osdfc/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_osdfc/>OSDFC 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2021_blueteam_village/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_blueteam_village/>BTV 2021</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a>
</div>
</li>
</ul>
</li>
<li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren">
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a>
</div>
</li>
<li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item>
<div>
<i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a>
</div>
</li>
</ul>
<hr>
<section id=shortcuts>
<h3></h3>
<ul>
<li>
<a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a>
</li>
<li>
<a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a>
</li>
<li>
<a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a>
</li>
</ul>
</section>
<section id=footer>
<div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7>
<br> <i class="fas fa-copyright"></i> 2021
</div>
</section>
</div>
</nav>
<script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=top-github-link>
<a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/blog/2021/2021-08-18-velociraptor-and-etw/_index.md target=blank>
<i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span>
</a>
</div>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
Event Tracing for Windows Part 1
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#digging-into-windows-internals>Digging into Windows Internals</a>
<ul>
<li><a href=#event-tracing-for-windows>Event tracing for windows.</a></li>
<li><a href=#exploring-etw---monitoring-dns-lookups>Exploring ETW - Monitoring DNS lookups</a></li>
</ul>
</li>
<li><a href=#deploying-the-query-on-endpoints>Deploying the query on endpoints</a></li>
<li><a href=#conclusions>Conclusions</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
<div class=tags>
<a class=tag-link href=/tags/detection>Detection</a>
<a class=tag-link href=/tags/vql>VQL</a>
<a class=tag-link href=/tags/etw>ETW</a>
</div>
</div>
<div id=body-inner>
<h1>
Event Tracing for Windows Part 1
</h1>
<div class="author pull-right">
Mike Cohen
<span class=date>2021-09-02</span>
</div>
<h2 id=digging-into-windows-internals>Digging into Windows Internals</h2>
<p>One of the most important aspects of modern operating systems is
instrumentation of the running software on the system. Instrumentation
provides the visibility to understand what the system is doing at any
given moment. This is obviously important for system administrators
and software developers, but visibility into machine state is
increasingly being used for security monitoring and response.</p>
<p>In Windows, system instrumentation is provided by the Event Tracing
For Windows (ETW), an extensive framework for instrumentation and
visibility.</p>
<p>Much has been written about ETW so I will not cover the details here,
this blog post is the first of a series of posts that examine how we
can leverage ETW for security monitoring using Velociraptor
specifically.</p>
<h3 id=event-tracing-for-windows>Event tracing for windows.</h3>
<p>The Event Tracing for Windows framework is <a href=https://docs.microsoft.com/en-us/windows-hardware/test/weg/instrumenting-your-code-with-etw>documented extensively by
Microsoft</a>. In
a nutshell, the framework is designed to facilitate interaction
between event <strong>Consumers</strong> and event <strong>Providers</strong>.</p>
<p>Velociraptor provides the VQL event plugin <code>watch_etw()</code> to register
Velociraptor as a <strong>Consumer</strong>. If you have not read about
Velociraptor&rsquo;s event queries, check out the
<a href=https://docs.velociraptor.app/docs/vql/events/>documentation</a>. In
Velociraptor, event queries allow us to write real time monitoring
rules on the endpoint, then forward events to the server, enrich the
event with other information or respond to the event autonomously.</p>
<p>In this blog post we will go through some examples to illustrate the
general technique but there are so many possibilities for advanced
detection rules.</p>
<h3 id=exploring-etw---monitoring-dns-lookups>Exploring ETW - Monitoring DNS lookups</h3>
<p>In this blog post, we will be building a Velociraptor query to monitor
for DNS lookups on the endpoint. We mentioned previously that ETW
connects providers and consumers, so our first task is simply to find
a provider that will provider relevant data.</p>
<p>In this post we explore how you might develop new ETW based queries by
discovering new providers and experimenting with novel detection
rules.</p>
<p>ETW is designed to be self documented via <code>manifest</code> files, so each
provider in the system can describe what it will provide to some
extent. You can see all the providers on your system using the <code>logman query providers</code> command. We can immediately see some providers
identified by the globally unique identifier (GUID).</p>
<p>
<figure>
<img src=query_providers.png alt="Querying providers on the command line" class=captioned>
<figcaption>Querying providers on the command line</figcaption>
</figure>
</p>
<p>Although it is possible to query for providers on the command line,
using APIs it is possible to dump the entire manifest containing much
more information about each provider.</p>
<p>There are some public efforts to better document ETW providers, for
example <a href=https://github.com/repnz/etw-providers-docs>https://github.com/repnz/etw-providers-docs</a> contains a dump of
various manifest files. I like to search that repository to find
likely useful providers. In this case I will look for a provider that
might give DNS information. The <code>Microsoft-Windows-DNS-Client</code>
provider looks like a likely candidate.</p>
<p>
<figure>
<img src=image118.png alt="ETW Providers documentation" class=captioned>
<figcaption>ETW Providers documentation</figcaption>
</figure>
</p>
<p>Let&rsquo;s get Velociraptor to watch the provider&rsquo;s GUID for any
events. VQL provides the <code>watch_etw()</code> plugin to attach Velociraptor
to the provider.</p>
<pre><code class=language-sql>SELECT *
FROM watch_etw(guid=&quot;{1C95126E-7EEA-49A9-A3FE-A378B03DDB4D}&quot;)
</code></pre>
<p>
<figure>
<img src=watching_dns_provider.png alt="Watching the Windows DNS Client provider" class=captioned>
<figcaption>Watching the Windows DNS Client provider</figcaption>
</figure>
</p>
<p>After some trial and error we find the event ID we are interested in
as being ID 3020. We can consult with the manifest file to get more
information, such as the event data provided. Limiting the VQL query
to filter for event 3020 and extracting the most relevant columns
gives a nice DNS monitoring query:</p>
<pre><code class=language-sql>SELECT System.TimeStamp AS Timestamp,
       EventData.QueryName AS Query,
       EventData.QueryType AS Type,
       EventData.QueryResults AS Answer
FROM watch_etw(guid=&quot;{1C95126E-7EEA-49A9-A3FE-A378B03DDB4D}&quot;)
WHERE System.ID = 3020
</code></pre>
<h2 id=deploying-the-query-on-endpoints>Deploying the query on endpoints</h2>
<p>Our VQL query is able to monitor the endpoint for DNS lookups but we
need a way to deploy the query to the endpoint. In Velociraptor,
client side event queries are encapsulated in <code>Client Event</code> artifacts
(Simple YAML files that include the VQL query, as well as human
readable descriptions and parameters allowing for simple
customization).</p>
<p>Simply select &ldquo;Add new artifact&rdquo; in the <code>View Artifacts</code> screen. By
default Velociraptor presents a template for an artifact definition -
ready for us to fill in the right information. Simply copy the VQL
query into the new artifact under the <code>Sources.Query</code> section
(remember to indent the query to fit within the YAML format). Since
this artifact will be an event artifact running on the client, we must
specify its type as <code>CLIENT_EVENT</code></p>
<p>
<figure>
<img src=event_artifact.png alt="Adding a custom event artifact" class=captioned>
<figcaption>Adding a custom event artifact</figcaption>
</figure>
</p>
<div class="mynotices tip">
<div heading=" The different types of artifacts "><p>What is the difference between a <code>CLIENT</code> and a <code>CLIENT_EVENT</code> artifact?</p>
<p>A <code>CLIENT</code> artifact is collected from the client, by sending a query,
having the client execute the query, returning a result set
(i.e. rows) back to the server. Therefore the <code>CLIENT</code> artifact
normally has a limited lifetime (by default 10 minutes) over which to
complete its work and return a result.</p>
<p><code>CLIENT_EVENT</code> artifacts are designed to run continuously on the
client, streaming rows to the server when events occur. Therefore
these are treated differently by the client: The client simply records
the event queries it is to run in a <code>Client Event Table</code>.</p>
<p>The client starts running all the event queries when it first
starts. If the client table changes on the server (perhaps because the
user added a new event artifact to the client), the client will resync
its event table and restart all its queries.</p>
</div>
</div>
<p>Once Velociraptor contains the new artifact it is time to deploy the
artifact to endpoints. Velociraptor can target different event
artifacts to different clients by means of <code>Label Groups</code>. By simply
assigning a label to a client, we can control the event artifacts
running on the client. For example, some of our endpoints are more
sensitive so we might want to only deploy certain monitoring queries
on those clients only by labeling them as &ldquo;Sensitive&rdquo;.</p>
<p>For our example, we will deploy the query on <code>All</code> clients.</p>
<p>
<figure>
<img src=adding_event_artifacts.png alt="Targeting event monitoring to label groups" class=captioned>
<figcaption>Targeting event monitoring to label groups</figcaption>
</figure>
</p>
<p>Once the query is deployed we can begin seeing any DNS events
generated on the endpoint.</p>
<p>
<figure>
<img src=monitoring_dns.png alt="Monitoring DNS requests" class=captioned>
<figcaption>Monitoring DNS requests</figcaption>
</figure>
</p>
<h2 id=conclusions>Conclusions</h2>
<p>Hopefully you were inspired by this post to search for your own
detection queries. ETW is a rich source of endpoint state telemetry!
There are many other providers to explore and many possibilities of
combining ETW with other information sources.</p>
<p>While many users are familiar with Velociraptor&rsquo;s ability to collect
endpoint state and hunt for indicators at scale, the event monitoring
capability is a different approach making certain types of detections
much more convenient and effective.</p>
<p>For example, many users ask &ldquo;how do I schedule a hunt to run
periodically?&rdquo; While there are some cases when this is a good solution,
in most cases users are trying to find out what has changed in the
endpoint&rsquo;s state between two times.</p>
<p>An event monitoring artifact can inform of state changes on the
endpoint and perform the preliminary triage and analysis of these
events automatically.</p>
<p>In the next part of this article series we will be examining more
examples of utilizing ETW for enhancing end point visibility and
facilitating advanced response. We will also be discussing limitations
with this technique.</p>
<p>If you have a great idea for a new detection query, take <a href=https://github.com/Velocidex/velociraptor>Velociraptor
for a spin</a>! It is a
available on GitHub under an open source license. As always please
file issues on the bug tracker or ask questions on our mailing list
<a href=mailto:velociraptor-discuss@googlegroups.com>velociraptor-discuss@googlegroups.com</a>
. You can also chat with us directly on discord
<a href=https://www.velocidex.com/discord>https://www.velocidex.com/discord</a>
.</p>
<p>There is still time to submit it to this year&rsquo;s <a href=https://docs.velociraptor.app/announcements/2021-artifact-contest/>2021 Velociraptor
Contributor
Competition</a>,
where you can win prizes, honor and support the entire DFIR
community. Alternatively, you can share your artifacts with the community on
<a href=https://docs.velociraptor.app/exchange/>Velociraptor&rsquo;s Artifact
Exchange</a>.</p>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1645356557></script>
<script src=/js/perfect-scrollbar.min.js?1645356557></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1645356557></script>
<script src=/js/jquery.sticky.js?1645356557></script>
<script src=/js/featherlight.min.js?1645356557></script>
<script src=/js/highlight.min.js?1645356557></script>
<script>hljs.highlightAll()</script>
<script src=/js/modernizr.custom-3.6.0.js?1645356557></script>
<script src=/js/learn.js?1645356557></script>
<script src=/js/hugo-learn.js?1645356557></script>
</body>
</html>