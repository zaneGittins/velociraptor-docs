<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.97.3"><meta name=description content="Velociraptor can use sftp to securely transfer data to an AWS S3 bucket. However configuring this service securely is not trivial. This post walks the reader through the steps of setting up a secure sftp upload only bucket that can be used with Velociraptor.
"><link rel=icon href=/images/favicon.png type=image/png><title>SFTP in AWS :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1650524696 rel=stylesheet><link href=/css/fontawesome-all.min.css?1650524696 rel=stylesheet><link href=/css/featherlight.min.css?1650524696 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1650524696 rel=stylesheet><link href=/css/auto-complete.css?1650524696 rel=stylesheet><link href=/css/theme.css?1650524696 rel=stylesheet><link href=/css/tabs.css?1650524696 rel=stylesheet><link href=/css/hugo-theme.css?1650524696 rel=stylesheet><link href=/css/theme-mine.css?1650524696 rel=stylesheet><link href=/css/dark.css?1650524696 rel=stylesheet><link href=/css/syntax.css?1650524696 rel=stylesheet><link href=/css/light.css?1650524696 rel=stylesheet><link href=/css/hljs.css?1650524696 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1650524696 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1650524696></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYH72LMYCS",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-QYH72LMYCS","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script></script></head><body data-url=/blog/2021/2021-12-11-sftp-in-aws/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp("theme=darkmode");regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a></div></li></ul></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a></div><ul><li data-nav-id=https://docs.velociraptor.app/presentations/2021_auscert/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_auscert/>Auscert 2021</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2021_dfrws_us/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_dfrws_us/>DFRWS US 2021 Workshop</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2021_osdfc/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_osdfc/>OSDFC 2021</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2021_blueteam_village/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2021_blueteam_village/>BTV 2021</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/knowledge_base/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/knowledge_base/><i class="fas fa-brain"></i>Knowledge Base</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a></li><li><a class=padding href=https://docs.velociraptor.app/rss/><i class="fas fa-rss"></i>RSS</a></li></ul></section><section id=footer><div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/Velocidex/velociraptor-docs/edit/master/content/blog/2021/2021-12-11-sftp-in-aws/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>SFTP in AWS</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#creating-an-aws-bucket>Creating an AWS bucket</a></li><li><a href=#aws-policies>AWS Policies</a><ul><li><a href=#velociraptor-upload-policy>velociraptor-upload-policy</a></li><li><a href=#velociraptor-sftp-upload-only>velociraptor-sftp-upload-only</a></li></ul></li><li><a href=#aws-roles>AWS Roles</a></li><li><a href=#creating-the-sftp-server>Creating the SFTP server</a></li><li><a href=#adding-sftp-users-to-the-sftp-server>Adding SFTP users to the sftp server.</a></li><li><a href=#testing-access-controls>Testing access controls</a></li><li><a href=#creating-an-sftp-offline-collector>Creating an SFTP Offline Collector</a></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/aws>AWS</a>
<a class=tag-link href=/tags/offline-collector>Offline Collector</a></div></div><div id=body-inner><h1>SFTP in AWS</h1><div class="author pull-right">Mike Cohen
<span class=date>2021-12-20</span></div><p>Many people use Velociraptor&rsquo;s <a href=/docs/offline_triage/>offline collector</a> feature to collect any artifacts without
having the Velociraptor client actually installed on the
endpoint. While the offline collector feature is great to
interactively triage a machine, the produced collection zip file is
normally quite large and unwieldy to transfer.</p><p>To help with this, Velociraptor offers the option to send the file
back to the cloud via a number of mechanisms, including upload to S3
buckets directly, WebDAV upload and using Secure FTP (sftp).</p><p>One of the challenges with automatic uploading to the cloud is
securely configuring the upload mechanism. Since the credentials for
any upload service are embedded inside the collector, it is important
to ensure that these credentials have minimal additional permissions.</p><p>For example, when using a cloud bucket to collect triage data from
endpoints, the bucket policy must be configured to allow a service
account full write access. However, using these credentials should not
allow anyone to list existing bucket resources, or to download
critical triage data from other hosts!</p><p>I have <a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>previously</a> described how to use Google cloud&rsquo;s service accounts to upload to
a GCP bucket securely.</p><p>In this post I describe how to set up Amazon&rsquo;s SFTP transfer service
to securely allow the Velociraptor collector to upload files without
granting the collector permission to download the files again, delete
them or discover other uploads in the bucket.</p><p>I would like to thank Simon Irwin from Rapid7 for his assistance and
guidance with AWS - I am certainly not an expert and needed a lot of
help figuring this process out. This is one of the reasons I wanted to
document the process in order to save others time.</p><h2 id=overview>Overview</h2><p>The main AWS service I will use is the <a href=https://docs.aws.amazon.com/transfer/latest/userguide/what-is-aws-transfer-family.html>AWS Transfer Family</a> documented extensively on the AWS documentation site.</p><p>In a nutshell, the service requires creating an sftp transfer server
backed by an S3 bucket. The SFTP server does not use real usernames
for authentication, but rather throwaway usernames I create just for
that service.</p><p>Each of these throwaway sftp users are given an SSH key pair (public
and private keys) which they use to authenticate with the service. The
private key will be embedded in the Velociraptor collector and allow
the collector to upload to the service. However, by setting up
restrictive policies I can limit the permissions of the sftp user.</p><h2 id=creating-an-aws-bucket>Creating an AWS bucket</h2><p>I will begin by creating an S3 bucket called <code>velociraptor-test</code> that
will contain all the collector files uploaded from the endpoints.</p><p><figure><img src=creating_S3_bucket.png alt="Creating an S3 bucket" class=captioned><figcaption>Creating an S3 bucket</figcaption></figure></p><h2 id=aws-policies>AWS Policies</h2><p>AWS controls access via roles and policies. For this configuration I
will need to create two policies:</p><ol><li><p>The first policy I will call <code>velociraptor-upload-policy</code> grants
full access to the AWS transfer service with full use of the
provided s3 bucket.</p></li><li><p>The second policy I will call <code>velociraptor-sftp-upload-only</code>
policy will apply to the sftp user and only grant upload
permissions.</p></li></ol><h3 id=velociraptor-upload-policy>velociraptor-upload-policy</h3><p>This policy grants full access to the new bucket I created earlier.</p><pre><code class=language-json>
{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
  {
    &quot;Effect&quot;: &quot;Allow&quot;,
    &quot;Action&quot;: [
      &quot;s3:PutObject&quot;,
      &quot;s3:GetObject&quot;,
      &quot;s3:ListBucket&quot;,
      &quot;s3:DeleteObject&quot;,
      &quot;s3:PutObjectAcl&quot;
    ],
    &quot;Resource&quot;: [
       &quot;arn:aws:s3:::velociraptor-test&quot;,
       &quot;arn:aws:s3:::velociraptor-test/*&quot;
    ]
  }
 ]
}
</code></pre><h3 id=velociraptor-sftp-upload-only>velociraptor-sftp-upload-only</h3><p>This policy only grants upload rights</p><pre><code class=language-json>{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
  {
    &quot;Sid&quot;: &quot;AllowListingOfUserFolder&quot;,
    &quot;Action&quot;: [
      &quot;s3:ListBucket&quot;
    ],
    &quot;Effect&quot;: &quot;Allow&quot;,
    &quot;Resource&quot;: [
      &quot;arn:aws:s3:::${transfer:HomeBucket}&quot;
     ],
    &quot;Condition&quot;: {
      &quot;StringLike&quot;: {
          &quot;s3:prefix&quot;: [
              &quot;${transfer:HomeFolder}/*&quot;,
              &quot;${transfer:HomeFolder}&quot;
          ]
      }
    }
  },
  {
    &quot;Sid&quot;: &quot;HomeDirObjectAccess&quot;,
    &quot;Effect&quot;: &quot;Allow&quot;,
    &quot;Action&quot;: [
      &quot;s3:PutObject&quot;,
      &quot;s3:PutObjectACL&quot;
    ],
    &quot;Resource&quot;: &quot;arn:aws:s3:::${transfer:HomeDirectory}*&quot;
  }
]
}
</code></pre><div class="mynotices note"><div heading=note><p>I found that I needed to give the <code>s3:ListBucket</code> permission in order
to upload files - this seems a bit strange to me but I could not get
upload to work without this permission. Despite having this
permission, it is still not possible to actually list the files in the
bucket anyway.</p></div></div><h2 id=aws-roles>AWS Roles</h2><p>An AWS role is a set of policies that applies to a particular
service. In this case I will create a new role that allows uploading
to the s3 bucket I created. Search for the <a href=https://console.aws.amazon.com/iamv2/home#/roles>IAM
screen</a> in the AWS
console and select &ldquo;Create a new role&rdquo;.</p><p>In the first step, the UI asks us to associate the role with a
service, Select the <code>Transfer</code> as the service.</p><p><figure><img src=create_role_1.png alt="Creating a new role" class=captioned><figcaption>Creating a new role</figcaption></figure></p><p>Next associate the role with the <code>velociraptor-upload-policy</code>
policy. I will name the role <code>velociraptor-upload-role</code>.</p><p><figure><img src=create_role_2.png alt="Creating a new role - associating with policy" class=captioned><figcaption>Creating a new role - associating with policy</figcaption></figure></p><h2 id=creating-the-sftp-server>Creating the SFTP server</h2><p>Now I need to create an sftp server in the Transfer service. Search
for the <a href=https://us-east-2.console.aws.amazon.com/transfer/home>AWS Transfer
Family</a> screen
and select &ldquo;Create Server&rdquo;. I will choose this to be an SFTP server.</p><p><figure><img src=creating_sftp_server.png alt="Creating the sftp server" class=captioned><figcaption>Creating the sftp server</figcaption></figure></p><p>The identity provider is &ldquo;Service managed&rdquo; - this means I will manage
the sftp users with throwaway ssh keys.</p><p><figure><img src=sftp_server_2.png alt="Creating the sftp server - Identity Providers" class=captioned><figcaption>Creating the sftp server - Identity Providers</figcaption></figure></p><p>Finally I will choose S3 to be our storage backend</p><p><figure><img src=sftp_server_3.png alt="Creating the sftp server - Backend storage" class=captioned><figcaption>Creating the sftp server - Backend storage</figcaption></figure></p><p>Once the server is created, the AWS console will remind us that no
users are added to the service yet. This will be our next task&mldr;</p><p><figure><img src=create_sftp_server_final.png alt="Creating the sftp server - Success!" class=captioned><figcaption>Creating the sftp server - Success!</figcaption></figure></p><h2 id=adding-sftp-users-to-the-sftp-server>Adding SFTP users to the sftp server.</h2><p>Our ultimate goal is to create throw-away sftp users which can
authenticate to the service with an SSH key pair and upload triage
files.</p><p>I will now create an SSH key pair on my machine - this will contain a
private key and a public key (Note: do not protect these keys with a
passphrase):</p><p><figure><img src=generating_keys.png alt="Generating SSH key pair for the new sftp user" class=captioned><figcaption>Generating SSH key pair for the new sftp user</figcaption></figure></p><p>In the AWS console I select the new server and click on &ldquo;Add user&rdquo; to
add a new user.</p><p><figure><img src=adding_user.png alt="Adding a new SFTP user" class=captioned><figcaption>Adding a new SFTP user</figcaption></figure></p><p>I will add the <code>velociraptor-upload-role</code> role I created earlier to
this sftp user, allowing the user to interact with the s3 bucket.</p><p>I will now also add a <code>scope down policy</code> to further restrict the
access this user has to upload only by selecting the
<code>velociraptor-sftp-upload-only</code> policy.</p><p>Next I will add the user&rsquo;s public key to the AWS console&rsquo;s
configuration by simply pasting the public key I generated earlier.</p><p><figure><img src=adding_public_key_to_user.png alt="Adding a new SFTP user&amp;rsquo;s public keys" class=captioned><figcaption>Adding a new SFTP user&amp;rsquo;s public keys</figcaption></figure></p><p>Finally I create the new user with the name <code>velouploader</code></p><div class="mynotices tip"><div heading=" Creating users with different access "><p>In our example I created a user with an upload only policy that could
not read any of the files in the bucket. However, you can also create
a user with full access to the bucket by removing the scope down policy
or apply a different policy per user.</p><p>This is convenient to allow the investigator the ability to download
the collected files by creating a separate sftp user for them without
a scope-down policy.</p></div></div><h2 id=testing-access-controls>Testing access controls</h2><p>It is imperative to ensure that access controls are working the way
they are supposed to! Therefore I will now test my setup using the
built in sftp client in my operating system (I can find the endpoint&rsquo;s
public DNS name using the AWS console).</p><pre><code class=language-sh>sftp -i sftpuser.key velouploader@s-9d35031a046643d88.server.transfer.us-east-2.amazonaws.com
</code></pre><p><figure><img src=testing_permissions.png alt="Testing ACLs" class=captioned><figcaption>Testing ACLs</figcaption></figure></p><p>At first I upload a small file and confirm it works as expected. Then
I try to list the directory, and read the file out again - both
attempts fail due to the scope down policy.</p><p>Finally attempting to overwrite the old file by re-uploading the same
file again, also fails.</p><h2 id=creating-an-sftp-offline-collector>Creating an SFTP Offline Collector</h2><p>I am now ready to create our offline collectors. I will login to
Velociraptor&rsquo;s web UI and navigate to <code>Server Artifacts</code> screen. Once
there I click the <code>Build Offline Collector</code> button. For this example,
I will create a collector using the <code>Windows.KapeFiles.Targets</code>
artifact and just collect the <code>$MFT</code> file.</p><p><figure><img src=kapefiles_1.png alt="Creating an offline collector" class=captioned><figcaption>Creating an offline collector</figcaption></figure></p><p>Now I will configure the collector to use the SFTP upload method,
giving the username I created earlier and pasting the private key I
generated.</p><p><figure><img src=kapefiles_2.png alt="Configuring the offline collector for SFTP uploads" class=captioned><figcaption>Configuring the offline collector for SFTP uploads</figcaption></figure></p><p>I selected the collection method to SFTP which changes the form to
allow for more parameters to be specified:</p><ul><li>The Private key is the file I generated earlier with <code>ssh-keygen</code> - I will just paste the file content into this form.</li><li>The user is the sftp user that Velociraptor will log in as.</li><li>The Endpoint is the DNS name of the sftp server I created followed
by a colon and the port number (usually port 22).</li></ul><p>Once the collector is created I am able to run it on a test system.</p><p><figure><img src=kapefiles_3.png alt="Running the collector to collect the MFT" class=captioned><figcaption>Running the collector to collect the MFT</figcaption></figure></p><p>As can be seen the upload is mostly fine except there are some
features that are not possible due to the restricted
permissions. Although, the log file shows a failure the file did
successfully upload as can be confirmed in the bucket view.</p><p><figure><img src=success.png alt="Verifying files uploaded in the S3 bucket" class=captioned><figcaption>Verifying files uploaded in the S3 bucket</figcaption></figure></p><h1 id=conclusions>Conclusions</h1><p>In this post I examined how to configure a secure SFTP upload service
in AWS that can safely receive triage data from the Velociraptor
offline collector.</p><p>The sftp uploading functionality is actually implemented by the
<code>upload_sftp()</code> plugin <a href=/vql_reference/basic/#upload_sftp>documented here</a>. This means that you can use
this functionality in any VQL query at all - either on the client side
or on the server side.</p><p>For example it is possible to automatically back up server side hunts
or collections to the SFTP bucket.</p><footer class=footline></footer></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//velocidex-velociraptor.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1650524696></script>
<script src=/js/perfect-scrollbar.min.js?1650524696></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1650524696></script>
<script src=/js/jquery.sticky.js?1650524696></script>
<script src=/js/featherlight.min.js?1650524696></script>
<script src=/js/highlight.min.js?1650524696></script>
<script>hljs.highlightAll()</script><script src=/js/modernizr.custom-3.6.0.js?1650524696></script>
<script src=/js/learn.js?1650524696></script>
<script src=/js/hugo-learn.js?1650524696></script></body></html>