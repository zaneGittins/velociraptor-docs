<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Migrating from OSQuery to Velociraptor :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1626078150 rel=stylesheet><link href=/css/fontawesome-all.min.css?1626078150 rel=stylesheet><link href=/css/featherlight.min.css?1626078150 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1626078150 rel=stylesheet><link href=/css/auto-complete.css?1626078150 rel=stylesheet><link href=/css/theme.css?1626078150 rel=stylesheet><link href=/css/tabs.css?1626078150 rel=stylesheet><link href=/css/hugo-theme.css?1626078150 rel=stylesheet><link href=/css/theme-mine.css?1626078150 rel=stylesheet><link href=/css/atom-one-light.css?1626078150 rel=stylesheet><link href=/css/dark.css?1626078150 rel=stylesheet><link href=/css/syntax.css?1626078150 rel=stylesheet><link href=/css/light.css?1626078150 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1626078150 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1626078150></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script></script></head><body data-url=/blog/2021/2021-02-03-migrating-from-osquery-to-velociraptor-d4143799953f/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/self-signed/>Self-Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/cloud/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/cloud/>Cloud Deployment</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/resources/>Performance</a></div></li></ul></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile machine state</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/api/>The API</a></div></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Velociraptor Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Velociraptor Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a></li></ul></section><section id=footer><div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/blog/2021/2021-02-03-migrating-from-osquery-to-velociraptor-d4143799953f/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Migrating from OSQuery to Velociraptor</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#tips-for-the-journey>Tips for the journey</a><ul><li><a href=#the-file-table>The file table</a></li><li><a href=#queries-and-artifacts>Queries and Artifacts</a></li><li><a href=#joins-and-foreach>Joins and foreach()</a></li><li><a href=#conclusions>Conclusions</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Migrating from OSQuery to Velociraptor</h1><h2 id=tips-for-the-journey>Tips for the journey</h2><p><figure><img src=https://cdn-images-1.medium.com/max/10944/0*592eCo6M0z0178xW alt='Photo by <a href="https://unsplash.com/@heidifin?utm_source=medium&amp;amp;utm_medium=referral">Heidi Fin</a> on <a href="https://unsplash.com?utm_source=medium&amp;amp;utm_medium=referral">Unsplash</a>' class=captioned><figcaption>Photo by &lt;a href="https://unsplash.com/@heidifin?utm_source=medium&amp;amp;utm_medium=referral">Heidi Fin&lt;/a> on &lt;a href="https://unsplash.com?utm_source=medium&amp;amp;utm_medium=referral">Unsplash&lt;/a></figcaption></figure><em>Photo by <a href="https://unsplash.com/@heidifin?utm_source=medium&utm_medium=referral">Heidi Fin</a> on <a href="https://unsplash.com?utm_source=medium&utm_medium=referral">Unsplash</a></em></p><p><a href=https://osquery.io/>OSQuery</a> has been around for a while now, and was actually the initial inspiration for Velociraptor. Back in the day, it became clear to me that the way to provide unprecedented flexibility for endpoint visibility was to have a flexible and powerful query language. OSQuery was historically a proof that a powerful query language was the way forward, and VQL was designed to improve on OSQuery and push the state of the art.</p><p>Many new Velociraptor users have existing OSQuery queries and installations and are migrating to Velociraptor for powerful and efficient endpoint visibility. I have written <a href=https://medium.com/velociraptor-ir/velociraptor-and-osquery-2a4306dd23c>previously about Velociraptor’s OSQuery integration</a>, allowing OSQuery queries to run directly inside Velociraptor.</p><p>This integration, however, is simply a stopgap measure during migration. It is much better to write VQL queries within Velociraptor, since VQL is much more powerful and also much faster.</p><p>This post aims to help this migration by comparing typical OSQuery queries with native VQL Velociraptor queries. This side by side comparison hopefully sheds some light on VQL and will encourage you to start writing new VQL artifacts.</p><p>This post does not compare the scalability, ease of deployment and management GUI of OSQuery‘s various fleet implementations with Velociraptor’s — we only look at the query language itself.</p><h3 id=the-file-table>The file table</h3><p>One of the most often used OSQuery table is the file table. For example we can see information about a file:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>“</span><span class=k>C</span><span class=p>:</span><span class=err>\</span><span class=n>Windows</span><span class=err>\</span><span class=n>notepad</span><span class=p>.</span><span class=n>exe</span><span class=err>”</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>Because OSQuery uses SQL as its underlying implementation, there is no way to tell the query that it is only interested in a single file (A naive implementation would scan all files on disk and compare the path by the condition eliminating all but one — a very expensive approach!).</p><p>To avoid a full scan of the filesystem, OSQuery peeks at the WHERE clause to figure out what it needs to do. It is therefore required that a WHERE clause is provided and the path or directory be restricted in some way.</p><p>Compare this to VQL. The main realization in VQL was that unlike in a relational database, tables are implemented by code, the code must be able to accept arguments. Therefore VQL’s syntax requires “tables” to take arguments (in VQL these are termed plugins):</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>glob</span><span class=p>(</span><span class=n>globs</span><span class=o>=</span><span class=err>”</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>notepad</span><span class=p>.</span><span class=n>exe</span><span class=err>”</span><span class=p>)</span><span class=w>
</span></code></pre></div><p>The VQL equivalent to the file table is the glob() plugin, which accepts a glob expression (i.e. wildcards) to search the filesystem directly. (Note also that VQL does not use a semicolon “;” as a statement separator — it is not needed, just string multiple statements together).</p><p>So far both queries simply return a single row for a specific file. OSQuery allows us to specify a wildcard for filenames as well, however it uses the SQL <strong>like</strong> syntax. For example to return all dlls in the system32 directory:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=err>“</span><span class=k>C</span><span class=p>:</span><span class=err>\</span><span class=n>Windows</span><span class=err>\</span><span class=n>system32</span><span class=err>\</span><span class=o>%</span><span class=p>.</span><span class=n>dll</span><span class=err>”</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>The equivalent VQL is</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>glob</span><span class=p>(</span><span class=n>globs</span><span class=o>=</span><span class=err>”</span><span class=k>C</span><span class=p>:</span><span class=err>\\</span><span class=n>Windows</span><span class=err>\\</span><span class=n>System32</span><span class=err>\\</span><span class=o>*</span><span class=p>.</span><span class=n>dll</span><span class=err>”</span><span class=p>)</span><span class=w>
</span></code></pre></div><p>You can test the VQL in the Velociraptor notebook right in the GUI. Simply select <strong>Notebooks</strong> from the sidebar and add a new notebook. Click on the top cell and add a new VQL cell where you can write arbitrary queries.</p><p><img src=../../img/1604zaUCaHumz_aHKaJY1Ig.png alt></p><p>You can also test OSQuery in the notebook cell by simply invoking the <code>Windows.OSQuery.Generic()</code> artifact (In this case Velociraptor will shell out to OSQuery and collect the results).</p><p><img src=../../img/1A6SW9z2b5anC7GHHZ2-Aeg.png alt></p><p>If you tried this you would immediately see a difference in performance — the VQL example took less than a second to return 3384 rows while OSQuery took over 6 sec to return the same data. While 6 seconds is not too bad, this gets worse when we try to fetch more dlls from the disk…</p><p>In VQL we can use <code>**</code> to denote recursive glob wildcard. This time the query took 2 seconds and returned 4090 rows.</p><p><img src=../../img/1Z2JdROd6jSvmSvxEB9p0QA.png alt></p><p>OSQuery uses %% for the same purpose. However OSQuery only allows a recursive wildcard at the end of a LIKE string (see discussion <a href=https://blog.kolide.com/the-file-table-in-osquery-is-amazing-99db0f52a066>here</a>), so we need to break up the condition into a more complex query with two conditions.</p><p><img src=../../img/1Jxcocb4GG8gnCEBugzMDjA.png alt></p><p>This time OSQuery takes 52 seconds to return the same number of rows. If you keep an eye on the task manager you would also see an increasing memory footprint for OSQuery because it queues up all rows in memory before returning them, so the more rows it returns the more memory it uses. If we now increase the size of the glob, to return all dlls on the system the query times out without returning any data at all!</p><p><img src=../../img/1eAv9VFpn-r_C6D8sGUVhhg.png alt></p><p>The timeout is imposed by Velociraptor’s OSQuery integration. This is another interesting difference between OSQuery and VQL — VQL has active query cancellation, and a timeout after which the query is cancelled (In this case the VQL that shells out to OSQuery has timed out and actively killed the OSQuery process after 10 minutes).</p><p>This makes running larger queries much safer as it provides an upper bound on the amount of resources taken on the endpoint. Once this bound is exceeded, the query is terminated.</p><p>Running a similar query with Velociraptor is much faster returning 64k rows in 66 seconds.</p><p><img src=../../img/1tQ3vq6-J7tVF_e0cloOWIg.png alt></p><p>Performance issues in the OSQuery file table have been discussed previously (see <a href=https://blog.kolide.com/the-file-table-in-osquery-is-amazing-99db0f52a066>https://blog.kolide.com/the-file-table-in-osquery-is-amazing-99db0f52a066</a>) and the advice is to just be more targeted in your queries, however if you need to know if a file exists anywhere on the disk then an exhaustive search is necessary.</p><p>Although being targeted is helpful, With VQL we can confidently run the exhaustive search because VQL has our back, in case our queries are more expensive than expected. VQL is designed to deal with many rows (e.g. the <code>Windows.NTFS.MFT</code> Artifact can return the entire contents of the MFT which can be around 400–500k rows within a couple minutes). VQL queries stream their results as soon as possible, so Velociraptor can maintain a low memory footprint even for very large result sets (typical memory footprint is 50–100mb).</p><p><strong>NOTE</strong>: VQL does not use the <strong>like</strong> keyword as in SQL. Instead VQL has the <strong>=~</strong> operator which means a regular expression match. SQL’s <strong>like</strong> syntax is archaic and much less powerful than a simple regular expression.</p><p>The following selects all user details for usernames matching “user” followed by a digit.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Artifact</span><span class=p>.</span><span class=n>Windows</span><span class=p>.</span><span class=n>Sys</span><span class=p>.</span><span class=n>Users</span><span class=p>()</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=o>=~</span><span class=w> </span><span class=err>“</span><span class=k>user</span><span class=p>[</span><span class=mi>0</span><span class=err>–</span><span class=mi>9</span><span class=p>]</span><span class=err>”</span><span class=w>
</span></code></pre></div><h3 id=queries-and-artifacts>Queries and Artifacts</h3><p>One major difference between OSQuery and Velociraptor is that Velociraptor does not usually directly run queries on endpoints. Instead, a VQL query is wrapped in an “Artifact” — a specially formatted YAML file which is stored within the Velociraptor server. Artifacts make queries discoverable and allow for queries to be shared with the community. Once an artifact is written, the user does not need to worry about remembering or entering a query.</p><p>Artifacts can also be directly used within another VQL query. This allows VQL to encapsulate a complex algorithm, but at the same time, users can easily build on top of this.</p><p>In contrast OSQuery uses hard coded internal tables to provide a lot of functionality requiring c++ coding to add a lot of simpler functionality to the tool.</p><p>Let’s consider the OSQuery <strong>chrome_extensions</strong> table — this table allows us to list all the chrome extensions installed by all users on the system. The query simply extract all rows but the actual logic of extracting and decoding the chrome extension data is hard coded inside OSQuery.</p><p><img src=../../img/1JV1XuRxZFwRJ0xNCS1k2UQ.png alt></p><p>On the other hand, Velociraptor’s <code>Windows.Applications.Chrome.Extensions</code> artifact is written in pure VQL (see <a href=https://github.com/Velocidex/velociraptor/blob/master/artifacts/definitions/Windows/Applications/Chrome/Extensions.yaml>the source code here</a>). You can view the artifact in the GUI by selecting the “View Artifact” screen from the sidebar. Note that artifacts can take parameters — in this case the artifact allows the user to adjust where the chrome extensions folder can be found.</p><p><img src=../../img/1NZA_Vj1kwrNF4hGx5Mrtaw.png alt></p><p>You can just call another artifact seamlessly from VQL as if it was just another plugin.</p><p><img src=../../img/14s-7aPELM12TKcRO4iK7Pg.png alt></p><p>This feature encourages users to develop reusable VQL Artifacts that can be put together like Lego bricks. Additionally, since artifacts are just VQL queries it is possible to add new capabilities to the tool with just a simple query — no need to write new tables in c++ like in OSQuery.</p><p>VQL provides very flexible primitives that can be much lower level than OSQuery. For example, a binary parser is provided built into the language, thereby allowing users to parse arbitrary files in their queries. The additional flexibility means that even complex functionality can be implemented entirely in VQL.</p><p>As a VQL query writer, seek to utilize one of the hundreds of built in artifacts in your queries. There are many artifacts that are functionally equivalent to OSQuery’s tables, but are written in VQL (So you can just customize them as well). If you come up with interesting artifacts, please share them with the community either by sending us a pull request on GitHub or hosting the YAML yourself.</p><h3 id=joins-and-foreach>Joins and foreach()</h3><p>Many newcomers to VQL look for the familiar SQL constructs like JOIN. However, VQL does not use joins at all, keeping the language simpler. In my experience SQL joins are confusing and difficult for people to really understand (quiz: what is the difference between a left join, right join, cross join, inner join and outer join?).</p><p>Since VQL can provide parameters to plugins, we can create a plugin which takes another query as a parameter. This is the fundamental idea behind the foreach() plugin (I wrote about it<a href=https://medium.com/velociraptor-ir/the-velociraptor-query-language-pt-2-fe92bb7aa150> previously</a>). The foreach plugin accepts the “rows” parameter and the “query” parameter. It simply runs the “rows” query and for each row it produces, the plugin evaluates the “query” query and emits the results.</p><p>Let’s take a simple example: an OSQuery query designed to display information about specific chrome extensions.</p><p><img src=../../img/12_aE3H4tGqcSQLw44l_iJQ.png alt></p><p>This OSQuery query joins the <strong>users</strong> table and the <strong>chrome_extension</strong> table to fill information about the user</p><p>The equivalent VQL simply runs two queries — for each row emitted by the <strong>Windows.Applications.Chrome.Extensions</strong> artifact that matches the extension of interest, we iterate over all the users, and select the user record of the user matching the relevant record so we can display its UUID.</p><p><img src=../../img/1uijQ0x2p97P13V66lkWFCQ.png alt></p><p>The VQL syntax is a lot of more readable without using a join statement. VQL also supports stored queries (similar to stored procedures) which take parameters and encourage query reuse.</p><p>A more refined query might use variables to store subqueries and then simply call them:</p><p><img src=../../img/1e_elJMJje0it3Da-M4OamQ.png alt></p><h3 id=conclusions>Conclusions</h3><p>This post described some of the more obvious differences between OSQuery and Velociraptor. To summarise</p><ol><li><p>The OSQuery file table equivalent is the VQL glob() plugin. Glob takes a glob expression as a parameter. Glob expressions use * and ** as wildcard instead of % or %%.</p></li><li><p>VQL does not have a like operator, instead using the regular expression operator =~</p></li><li><p>The Glob plugin is much faster than the OSQuery file table and there are no restrictions on where a recursive wildcard goes.</p></li><li><p>VQL queries time out by default after 10 min so there is no danger of overrunning the endpoint. If you prefer low and slow approach it is possible to rate limit the VQL query as well as increase the timeout.</p></li><li><p>Artifacts are YAML files that encapsulate VQL queries. Velociraptor does not directly collect VQL queries on the endpoint — you need to create an artifact first.</p></li><li><p>If you previously reached for an OSQuery table that provides the data you need, simply look at existing VQL Artifacts that do the same. If there are none available, you can add your own <strong>Artifacts</strong> in a modular way in the GUI (without needing to rebuild clients or servers).</p></li><li><p>VQL does not use <strong>join</strong>, instead the foreach plugin provides the same functionality in a clearer way. Foreach also takes the <strong>workers</strong> parameter allowing it to run concurrently on multiple cores.</p></li></ol><p>Users who are currently migrating from OSQuery can still reuse the existing investment they have in OSQuery queries directly in Velociraptor, but I hope this article convinced you that it is well worth porting your existing queries to native Velociraptor VQL to take advantage of the flexibility and performance enhancements that Velociraptor offers.</p><p>The above example is just one of the exercises we do in our hands on Velociraptor courses. If you are interested in learning more about Velociraptor, check out our hands on training courses on <a href=https://www.velocidex.com/training/>https://www.velocidex.com/training/</a> or check out the code on <a href=https://github.com/Velocidex/velociraptor>GitHub</a>. To chat, please join us on discord <a href=https://www.velocidex.com/discord>https://www.velocidex.com/discord</a>.</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1626078150></script><script src=/js/perfect-scrollbar.min.js?1626078150></script><script src=/js/perfect-scrollbar.jquery.min.js?1626078150></script><script src=/js/jquery.sticky.js?1626078150></script><script src=/js/featherlight.min.js?1626078150></script><script src=/js/highlight.pack.js?1626078150></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1626078150></script><script src=/js/learn.js?1626078150></script><script src=/js/hugo-learn.js?1626078150></script></body></html>