<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=description content="Path handling seems like a simple task but it is surprisingly complex. This article discusses some of the nuances of thinking about paths and introduces Velociraptor's new OSPath feature that easier path manipulation from VQL queries.
"><link rel=icon href=/images/favicon.png type=image/png><title>Paths and filesystem accessors :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1677678671 rel=stylesheet><link href=/css/fontawesome-all.min.css?1677678671 rel=stylesheet><link href=/css/featherlight.min.css?1677678671 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1677678671 rel=stylesheet><link href=/css/auto-complete.css?1677678671 rel=stylesheet><link href=/css/theme.css?1677678671 rel=stylesheet><link href=/css/tabs.css?1677678671 rel=stylesheet><link href=/css/hugo-theme.css?1677678671 rel=stylesheet><link href=/css/theme-mine.css?1677678671 rel=stylesheet><link href=/css/dark.css?1677678671 rel=stylesheet><link href=/css/syntax.css?1677678671 rel=stylesheet><link href=/css/light.css?1677678671 rel=stylesheet><link href=/css/hljs.css?1677678671 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1677678671 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1677678671></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYH72LMYCS",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-QYH72LMYCS","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script></script></head><body data-url=/blog/2022/2022-03-21-paths/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp("theme=darkmode");regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a></div><ul><li data-nav-id=https://docs.velociraptor.app/announcements/2023-cves/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2023-cves/>Current CVEs</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/references/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/references/>Config Reference</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a></div></li></ul></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a></div><ul><li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_auscert/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_auscert/>Auscert 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_us/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_us/>DFRWS US 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_tech_user_group_cbr/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_tech_user_group_cbr/>Tech Users Group 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_sans_summit/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_sans_summit/>SANS Summit 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_velocon/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_velocon/>Velocon 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_apac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_apac/>DFRWS APAC 2022</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/artifact_references/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/artifact_references/><i class="fas fa-book"></i>Artifact Reference</a></div></li><li data-nav-id=https://docs.velociraptor.app/knowledge_base/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/knowledge_base/><i class="fas fa-brain"></i>Knowledge Base</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class='fas fa-search'></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class='fab fa-github'></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class='fab fa-discord'></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class='fas fa-envelope'></i>Mailing List</a></li><li><a class=padding href=https://docs.velociraptor.app/rss/><i class='fas fa-rss'></i>RSS</a></li></ul></section><section id=footer><div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2022</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title='Edit this page' href=https://github.com/Velocidex/velociraptor-docs/edit/master/content/blog/2022/2022-03-21-paths/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Paths and filesystem accessors</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#the-ospath-abstraction>The OSPath abstraction</a></li><li><a href=#the-glob-plugin>The glob() plugin</a></li><li><a href=#filesystem-accessors-and-ospath>Filesystem accessors and OSPath</a></li><li><a href=#nested-accessors-and-pathspecs>Nested accessors and pathspecs</a></li><li><a href=#nesting-ospath-objects>Nesting OSPath objects.</a></li><li><a href=#compatibility-with-previous-releases>Compatibility with previous releases</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/forensics>Forensics</a>
<a class=tag-link href=/tags/vql>VQL</a></div></div><div id=body-inner><h1>Paths and filesystem accessors</h1><div class="author pull-right">Mike Cohen
<span class=date>2022-03-20</span></div><div class="mynotices note"><div heading=note><p>This article discusses a feature available since 0.6.4 release.</p></div></div><p>Path handling is fundamental to forensic analysis, as a large amount
of relevant information is still kept on disk within a
filesystem. Superficially, We are all familiar with how paths work - a
path is typically a string that we can provide to some OS API (for
example the Windows <code>CreateFile()</code> or Linux <code>open()</code> API) which
facilitates interacting with a file or a directory on the filesystem.</p><p>Unfortunately, the structure of this string is often not well defined
or consistent between operating systems! For example, on windows a
path has the following characteristics:</p><ol><li>The path starts with a &ldquo;drive letter&rdquo; of the form <code>C:</code> or <code>D:</code></li><li>Path directories are separated by a backslash <code>\</code></li><li>There is no leading path separator (<code>C:\</code> does not start with <code>\</code>).</li><li>Directory names may not contain forward slashes, backslashes or wildcards.</li><li>Filenames are generally case insensitive.</li></ol><p>For example <code>C:\Windows\System32\Notepad.exe</code></p><p>On Linux things are a bit different:</p><ol><li>Paths begin with the slash character (the root of the filesystem)</li><li>Path directories are separated by forward slash</li><li>Directory names may contain backslashes but these are <strong>not</strong> path
separators! Filename may contain pretty much any character (except
null and forward slash).</li></ol><p>For example, a path looks like <code>/usr/bin/ls</code>. However, since Linux can
have backslashes with filenames, the path <code>/C:\Windows/System32</code> can
actually refer to a single directory named <code>C:\Windows</code>!</p><p>It gets even more complicated on windows, where a <code>device name</code> may
appear as the first element of the path where it refers to a physical
device for example <code>\\.\C:\Windows</code> means the <code>Windows</code> directory
inside the filesystem on the device <code>\\.C:</code> - Yes the device can
contain backslashes which are also path separators <strong>except</strong> when
they refer to a device.</p><p>A registry path has other rules:</p><ol><li>It starts with the hive name, e.g. <code>HKEY_LOCAL_MACHINE</code> or <code>HKLM</code></li><li>Components are separated by backslashes</li><li>While key names are analogous to directories, registry keys are
allowed to have forward slash characters.</li><li>While Value name are analogous to files, value name may also have
backslashes!</li></ol><p>For example the following registry path is valid
<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\</code> <code>Windows Presentation Foundation\Namespaces\http://schemas.microsoft.com/netfx/2009/xaml/presentation</code>
(with the last registry key being a URL) even though the registry key
contains forward slashes it is just one key component!</p><p>With all these confusing rules we need to develop an abstraction that
allows Velociraptor to handle all these cases correctly.</p><h2 id=the-ospath-abstraction>The OSPath abstraction</h2><p>Recent Velociraptor releases, introduced the <code>OSPath</code> abstraction to
handle various paths:</p><ol><li><p>Internally paths are always a list of components. For example, the
windows path <code>C:\Windows\System32</code> is represented internally as the
list of components <code>["C:", "Windows", "System32"]</code></p></li><li><p>A Filesystem is treated as a tree, and the path is simply the list
of components connecting each level in the tree.</p></li><li><p>An <code>OSPath</code> implements specific serialization and deserialization
methods: When we need to pass an OSPath object to the OS API we
need to serialize the abstract OSPath in a way that is appropriate
to the OS. Otherwise we prefer to retain the OSPath as an abstract
path as much as possible.</p></li><li><p>Each <code>OSPath</code> has a specific flavor - controlling for the way it is
serialized to and from a string.</p></li></ol><p>For example, an OSPath with the following components <code>["C:", "Windows", "System32"]</code> will serialize to string:</p><ul><li>A Windows <code>OSPath</code> will serialize to <code>C:\Windows\System32</code></li><li>A Linux <code>OSPath</code> will serialize to <code>/C:/Windows/System32</code></li><li>A Windows NTFS aware OSPath will serialize to
<code>\\.\C:\Windows\System32</code> (i.e. device notation appropriate to the
NTFS raw accessor).</li></ul><h2 id=the-glob-plugin>The glob() plugin</h2><p>One of the most commonly used plugins in Velociraptor is the <code>glob()</code>
plugin. This plugin allows searching of filesystems using a glob
expression (containing wildcards).</p><p>Consider the following query running on windows</p><pre><code class=language-vql>SELECT OSPath
FROM glob(globs=&quot;C:\\Windows\\*&quot;)
</code></pre><p>The <code>glob()</code> plugin applies the glob expression on the filesystem and
returns a single row for each matching file. Since release <code>0.6.4</code>,
the raw <code>OSPath</code> object is also available within VQL. While it may
appear that it is a simple string when serialized to JSON, it is in
fact an object with many convenient methods.</p><p><figure><img src=ospath.png alt="The OSPath object" class=captioned><figcaption>The OSPath object</figcaption></figure></p><p>The OSPath object has some convenient properties:</p><ul><li><p>The <code>Components</code> field contains the list of path components in the
path. You can index the component to identify a specific directory
or filename. (negative indexes are counted from the end of the
component array).</p></li><li><p>The <code>Basename</code> property is a shorthand to the last component
(equivalent to <code>OSPath.Components[-1]</code>)</p></li><li><p>The <code>Dirname</code> property is an OSPath representing the directory
containing the OSPath.</p></li><li><p>Path manipulation is very easy to do, since OSPath is overloading
the addition operator. The expression <code>OSPath.Dirname + "explorer.exe"</code> produces another OSPath obtained by appending the
<code>explorer.exe</code> component to the directory of the current OSPath.</p></li></ul><h2 id=filesystem-accessors-and-ospath>Filesystem accessors and OSPath</h2><p>Velociraptor accesses filesystems by way of an <code>accessor</code>. You can think
of an accessor as a specific driver that VQL can use to open a
path. All VQL plugins or functions that accept files will also accept
an accessor to use to open the file.</p><p>Consider the following VQL query:</p><pre><code class=language-vql>SELECT read_file(path=&quot;C:/Windows/notepad.exe&quot;, accessor=&quot;file&quot;)
FROM scope()
</code></pre><p>The <code>read_file()</code> VQL function reads raw data from the specified
file. It will call onto the &ldquo;file&rdquo; accessor and pass the provided path
to it as an opaque string.</p><p>The <code>file</code> accessor is used to open files using the OS
APIs. Therefore, it will interpret the path string according to the OS
convention it is running on (i.e. on Windows it will create a Windows
flavor of OSPath). However, were we to use another accessor, the
string path will be interpreted differently by the accessor.</p><div class="mynotices note"><div heading=" Interpreting paths "><p>The most important takeaway from this is that when an accessor
receives a string path, it will parse it into an OSPath internally
according to its own rules.</p><p>When an accessor receives an already parsed OSPath object, it may
directly use it (since no parsing is required). Therefore in general,
once an OSPath object is produced in the query, the same OSPath object
should be passed around to other plugins/vql functions.</p><pre><code class=language-vql>SELECT read_file(filename=OSPath, accessor=&quot;file&quot;, length=5)
FROM glob(globs=&quot;C:\\Windows\\notepad.exe&quot;)
</code></pre></div></div><h2 id=nested-accessors-and-pathspecs>Nested accessors and pathspecs</h2><p>Many VQL accessors require additional information to be able to
work. For example consider the <code>zip</code> accessor. This accessor is used
to read zip archive members as if they were simple files. In order to
open an archive member we need several pieces of information:</p><ol><li>The path to the zip file itself.</li><li>An accessor to use to open the zip file container.</li><li>The path to the zip member inside the container to open.</li></ol><p>The <code>zip</code> accessor therefore requires a more complex OSPath object
containing additional information about the <code>Delegate</code> (i.e. the path
and accessor that the zip accessor will delegate the actual reading
to). We call this more complex path specification a <code>pathspec</code> as it
specifies more precisely what the accessor should do. In a VQL query
we may build a pathspec from scratch using the <code>pathspec</code> function.</p><pre><code class=language-vql>SELECT read_file(
  filename=pathspec(DelegateAccessor=&quot;file&quot;,
                    DelegatePath=&quot;F:/hello.zip&quot;,
                    Path=&quot;/hello.txt&quot;),
  accessor=&quot;zip&quot;, length=5)
FROM scope()
</code></pre><p>In the above example I am calling the <code>read_file()</code> VQL function, and
building an OSPath object directly using the <code>pathspec()</code> VQL
function.</p><p>The <code>zip</code> accessor receives the new OSPath object and</p><ol><li>Will open the zip container itself using the <code>Delegate</code>: i.e. the
&ldquo;file&rdquo; accessor, with a path of &ldquo;F:/hello.zip&rdquo;.</li><li>After parsing the zip file, the <code>zip</code> accessor will open the member
within it specified by the <code>Path</code> field. For zip files, the path is
interpreted as a forward slash separated unix like path (according
to the zip specification). In this case the zip accessor will open
a member called <code>hello.txt</code>.</li></ol><h2 id=nesting-ospath-objects>Nesting OSPath objects.</h2><p>We can combine the previous two queries to search zip files</p><pre><code class=language-vql>SELECT OSPath,
   read_file(filename=OSPath, accessor=&quot;zip&quot;, length=5)
FROM glob(
  globs=&quot;/*.txt&quot;,
  root=pathspec(DelegateAccessor=&quot;file&quot;, DelegatePath=&quot;F:/hello.zip&quot;, Path=&quot;/&quot;),
  accessor=&quot;zip&quot;)
</code></pre><p>This time we provide the <code>glob()</code> plugin the root (where searching
will begin) as a full OSPath object that we construct to represent the
top level of the zip archive (i.e. globing will proceed within the zip
file).</p><p>We can transparently now pass the OSPath object that glob will return
directly into any VQL function or plugin that accepts a file
(e.g. <code>read_file()</code>)</p><p><figure><img src=nested_pathspec.png alt="Handling nested OSPath objects" class=captioned><figcaption>Handling nested OSPath objects</figcaption></figure></p><p>The OSPath object is now capable of more complex path manipulations:</p><ol><li><p>The <code>OSPath.Dirname</code> property represents the fully qualified OSPath
used to represent the container directory - we can simply pass it
directly to any plugins that deal with directories.</p></li><li><p>Note that more complex <code>Pathspec</code> based paths are represented as a
JSON encoded object. It is ok to pass the stringified version the
OSPath around to plugins because they will automatically parse the
string into an OSPath object.</p></li></ol><div class="mynotices warning"><div heading=" Glob's root parameter "><p>In previous versions of Velociraptor it was possible to pass a
pathspec to the glob parameter (e.g. to glob within a zip file)
however since 0.6.4 this is not allowed. Glob expressions are always
flat strings (i.e. a glob is not a pathspec). A pathspec is allowed to
be passed to the root parameter to indicate where searching should
start from.</p></div></div><h2 id=compatibility-with-previous-releases>Compatibility with previous releases</h2><p>Previously the <code>glob()</code> plugin would emit the <code>FullPath</code> column as a
string representing the serialized version of each file. This string
was passed to other plugins/vql functions which parsed it again. This
lead to a lot of unnecessary path serialization and parsing, but more
importantly it was difficult to maintain the correct &ldquo;flavor&rdquo; of the
path throughout the query and required a lot of complex path
manipulations to extract specific parts of the path.</p><p>It should be more efficient to pass the raw OSPath object everywhere
the old FullPath was used. However 0.6.4 onward still provide the
FullPath column for backwards compatibility. The overall effect is
that artifacts originally written for older versions of VQL should
continue to work on 0.6.4. However newer artifacts written for 0.6.4
will not run on older clients.</p><p>Previously nested paths were encoded with URLs, but this is now
deprecated and future VQL queries should not use URLs to encode nested
paths.</p><div class="mynotices warning"><div heading=" Supporting older clients "><p>Many people upgrade their Velociraptor server more frequently than
their clients. Usually, newer versions of Velociraptor maintains
reasonable backwards compatibility with older clients so most things
continue to work. However in 0.6.4, the introduction of the <code>OSPath</code>
column means that newer artifacts will fail on older clients (since
VQL is evaluated on the client).
See our <a href=/docs/overview/support/>Support Policy</a></p><p>To help with the migration process, we made the older versions of
artifacts easily available in newer servers. If you still have older
clients deployed, you should import older VQL artifacts into <code>0.6.4</code>
server using the <code>Server.Import.PreviousReleases</code> server
artifact. This will import the old artifacts under a name reflecting
their version so they may be collected from older clients.</p></div></div><h2 id=conclusions>Conclusions</h2><p>Path representation is surprisingly much more complex that it first
appears. While paths are strings, internally Velociraptor treats them
as a sequence of components with different flavors controlling how
they are serialized and represented. This affords the VQL query a more
powerful way to manipulate paths and build new paths based on them.</p><p>For more complex accessors, paths are represented as a JSON serialized
<code>pathspec</code> object, describing a delegate container path as well. Using
the <code>OSPath</code> object methods does the right thing even for more complex
path and makes it a lot easier to manipulate (for example
<code>OSPath.Dirname</code> is a valid and correct <code>OSPath</code> for the containing
directory, even for more complex pathspec based paths)</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1677678671></script>
<script src=/js/perfect-scrollbar.min.js?1677678671></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1677678671></script>
<script src=/js/jquery.sticky.js?1677678671></script>
<script src=/js/featherlight.min.js?1677678671></script>
<script src=/js/highlight.min.js?1677678671></script>
<script>hljs.highlightAll()</script><script src=/js/modernizr.custom-3.6.0.js?1677678671></script>
<script src=/js/learn.js?1677678671></script>
<script src=/js/hugo-learn.js?1677678671></script></body></html>