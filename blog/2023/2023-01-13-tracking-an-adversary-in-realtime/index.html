<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=description content="This blog explains how you can use Velociraptor to enable real-time monitoring.
"><link rel=icon href=/images/favicon.png type=image/png><title>Tracking an adversary in real-time using Velociraptor :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1674224717 rel=stylesheet><link href=/css/fontawesome-all.min.css?1674224717 rel=stylesheet><link href=/css/featherlight.min.css?1674224717 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1674224717 rel=stylesheet><link href=/css/auto-complete.css?1674224717 rel=stylesheet><link href=/css/theme.css?1674224717 rel=stylesheet><link href=/css/tabs.css?1674224717 rel=stylesheet><link href=/css/hugo-theme.css?1674224717 rel=stylesheet><link href=/css/theme-mine.css?1674224717 rel=stylesheet><link href=/css/dark.css?1674224717 rel=stylesheet><link href=/css/syntax.css?1674224717 rel=stylesheet><link href=/css/light.css?1674224717 rel=stylesheet><link href=/css/hljs.css?1674224717 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1674224717 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1674224717></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYH72LMYCS",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-QYH72LMYCS","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script></script></head><body data-url=/blog/2023/2023-01-13-tracking-an-adversary-in-realtime/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp("theme=darkmode");regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/announcements/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/announcements/><i class="fas fa-bullhorn"></i>Announcements</a></div><ul><li data-nav-id=https://docs.velociraptor.app/announcements/2023-cves/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/announcements/2023-cves/>Current CVEs</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/references/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/references/>Config Reference</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a></div></li></ul></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a></div><ul><li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_auscert/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_auscert/>Auscert 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_us/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_us/>DFRWS US 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_tech_user_group_cbr/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_tech_user_group_cbr/>Tech Users Group 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_sans_summit/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_sans_summit/>SANS Summit 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_velocon/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_velocon/>Velocon 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_apac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_apac/>DFRWS APAC 2022</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/artifact_references/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/artifact_references/><i class="fas fa-book"></i>Artifact Reference</a></div></li><li data-nav-id=https://docs.velociraptor.app/knowledge_base/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/knowledge_base/><i class="fas fa-brain"></i>Knowledge Base</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class='fas fa-search'></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class='fab fa-github'></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class='fab fa-discord'></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class='fas fa-envelope'></i>Mailing List</a></li><li><a class=padding href=https://docs.velociraptor.app/rss/><i class='fas fa-rss'></i>RSS</a></li></ul></section><section id=footer><div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2022</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title='Edit this page' href=https://github.com/Velocidex/velociraptor-docs/edit/master/content/blog/2023/2023-01-13-tracking-an-adversary-in-realtime/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Tracking an adversary in real-time using Velociraptor</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#example-1-track-commands>Example 1: Track commands</a><ul><li><a href=#why-sysmon>Why Sysmon?</a></li></ul></li><li><a href=#example-2-track-compromised-accounts>Example 2: Track compromised accounts</a><ul><li><a href=#monitor-vs-contain>Monitor vs contain</a></li></ul></li><li><a href=#sending-alerts>Sending alerts</a></li><li><a href=#creating-an-overview-of-alerts>Creating an overview of alerts</a></li><li><a href=#test-test-test>Test. Test. Test.</a></li><li><a href=#what-more-can-be-done>What more can be done?</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Tracking an adversary in real-time using Velociraptor</h1><div class="author pull-right">Jos Clephas - @DfirJos
<span class=date>2023-01-09</span></div><p>As an incident responder that is fighting an adversary, you typically
want to be alerted the moment they conduct hands-on-keyboard activity
on systems of the IT-infrastructure that you are investigating. This
blog post shows you two practical examples on how to achieve this with
Velociraptor.</p><p>While detection is not the most typical use-case of Velociraptor, it
can be used for that. And to me it has proven to be valuable during
engagements when the deployed Endpoint Detection and Response (EDR)
solution lacked certain detection capabilities, or when it was not
deployed.</p><h2 id=example-1-track-commands>Example 1: Track commands</h2><p>Adversaries often use commands to conduct their malicious
activity. Receiving an alert when these commands are launched is very
valuable as it allows you to respond quickly.</p><p>Let&rsquo;s say you observed that the adversary planted a backdoor on a
remote system using the following scheduled task command:</p><pre><code>schtasks /Create /SC minute /mo 5 /TN WindowsUpdateCheck /TR C:/Perflog/m.exe&quot; /ru system /s srv_dc01 /u adm_peter /p adminpw
</code></pre><p>Using Velociraptor in combination with the system monitoring tool
&lsquo;Sysmon&rsquo; you’re able to build detection. There is no need to manually
install Sysmon, if you follow the steps below it will do it for you.</p><ol><li>Open the GUI of the Velociraptor server.</li><li>Select a random client.</li></ol><p><img src=images/4.png alt></p><ol start=2><li>Go the ‘Client Events’ menu and choose &lsquo;Update the client monitoring table&rsquo;.</li></ol><p><img src=images/1.png alt></p><ol start=3><li><p>Select the label group, and go to the next window ‘Select
Artifacts’</p></li><li><p>Select the artifact <code>Windows.Detection.ProcessCreation</code>. Optional:
if you want to deploy a custom Sysmon config choose <code>SysmonConfig</code>
and select it. By default, it selects this config:
<a href=https://github.com/SwiftOnSecurity/sysmon-config>https://github.com/SwiftOnSecurity/sysmon-config</a></p></li></ol><p><img src=images/12.png alt></p><ol start=5><li>Adjust the parameters. Below I provided an example of how to
detect the scheduled task command.</li></ol><p><img src=images/2.png alt></p><p>The regex I used matches specific parameters in the scheduled task
command.</p><pre><code>(?:(\/ru)|(\/p)|(\/s))
</code></pre><p>And the advantage of starting the regex with <code>(?:</code> and combining it
with capture groups <code>()</code> with pipes <code>|</code> between them, is that the
order does not matter. Meaning that even if the adversary shifts some
parameters in the command, the detection still works.</p><p>Another way that I used to make it a bit harder for the adversary to
evade detection, is to filter on the PE Original FileName instead of
the Image name. This way detection still works even if the adversary
changes the filename of the binary (in the figure above you see that
<code>lolbin.exe</code> was renamed from <code>schtasks.exe</code>). Note that detecting on the
PE Original Filename will not work anymore if the adversary modified
the PE header and changed the original filename - which can be done
with a HEX editor, for example.</p><h3 id=why-sysmon>Why Sysmon?</h3><p>The artifact shown in this example installs <code>Sysmon</code>. The reason I
used Sysmon is that it logs process creation events without failing,
even when it is a short-lived process. Missed events result in
unreliable detection.</p><p>An alternative to Sysmon was consuming process-related events directly
from Event Tracing for Windows (ETW). ETW is a mechanism that
Microsoft built for troubleshooting and diagnostics, and it provides
an enormous amount of events generated by the OS. The process-related
events are generated by the ETW provider
<code>Microsoft-Windows-Kernel-Process</code> that has the guid
<code>{22fb2cd6-0e7b-422b-a0c7-2fad1fd0e716}</code>. My testing with this
provider resulted in a lot of missed events by Velociraptor (possibly
due to the high-volume). And also, short-lived processes could not be
enriched with commandline parameters. That is because these parameters
are not provided by ETW, and enriching with the process running in
memory sometimes fails as it is shutdown too early.</p><p>For example, running the following command that lists content of a
remote drive <code>dir \\10.96.20.20\c$</code> sometimes only logs <code>dir</code> because
enriching failed. And therefore your detection would not work if you
attempt to match on commandline. Which is something you would want in
this case, because matching on only <code>dir</code> would undoubtedly result in
too many false-positives.</p><p>Because I wanted reliable detection I chose Sysmon instead of directly
consuming the process events from the aforementioned ETW provider.</p><h2 id=example-2-track-compromised-accounts>Example 2: Track compromised accounts</h2><p>The Windows Event Log is a great log source that enables you to track
adversary activity in real-time. Due to the Event Log tracker of
Velociraptor, you can easily monitor for new entries.</p><p>Let’s say the adversary uses the Windows accounts <code>adm_peter</code> and
<code>svc_iis</code> to move laterally through the IT-infrastructure, you can
monitor for any activity concerning these accounts using the artifact
<code>Windows.Events.Trackaccount</code>.</p><p>To configure this using the GUI of the Velociraptor server, go to:</p><ol><li>Select a random client:</li></ol><p><img src=images/4.png alt></p><ol start=2><li>Go to ‘Client Events’ in the menu</li><li>Choose ‘Update client monitoring table’</li></ol><p><img src=images/5.png alt></p><ol start=3><li>Select the <code>Label group</code> and go to the next window.</li><li>Select the artifact <code>Windows.Events.Trackaccount</code>.</li><li>Configure the artifact parameters. In the example below it logs
authentication events (Windows Event ID ‘4624’) concerning the
accounts <code>adm_peter</code> and <code>svc_iis</code>. You are also able to specify
the <code>LogonType</code> (3 = network logon, 10 = interactive logon, etc).</li></ol><p><img src=images/6.png alt></p><h3 id=monitor-vs-contain>Monitor vs contain</h3><p>When reading the above example you might have thought: &ldquo;why should I
monitor a compromised account when I can disable it?&rdquo; There are valid
reasons why in some cases you first want to monitor for a while. For
example, when you disable only one account, and the adversary also
compromised other accounts, you did not stop or slow down the
adversary. And you likely only alerted them that you are after their
tail. Which is something you want to avoid, as the adversary might
change tactics which makes it harder for you to track hem.</p><p>Another reason why it sometimes makes sense to leave the account
active, is to monitor it with the goal in mind to learn about the
Tools, Tactics, and Procedures (TTP) of the adversary. This in turn
can be used to strengthen the organization their defenses to prevent
similar incidents from occurring again in the future.</p><p>There are also valid reasons why you would want to disable compromised
accounts immediately instead of monitoring for a while. For example,
when it actually slow down or stop the adversary, or when it is the
policy of the organization.</p><p>Even better containment tactics to stop the adversary, are listed
below. These are particularly helpful when the extend of the
compromise is not yet clear.</p><ul><li>Block or limit outbound network-communication. If done correctly
this will prevent active command & control (C&C) channels.</li><li>Block DNS requests to external servers as DNS can tunnel C&C
traffic.</li><li>Block or limit inbound network-communication. As the adversary could
have placed web-shells on web servers, or compromised other potential
entry points.</li></ul><p>It is important to have a discussion of the above with the
client. They typically want to balance the potential risk of the
compromise against the operational impact. In the end they are the
ones who need to make that decision.</p><p>At some point in the investigation you definitely want to disable all
compromised accounts or reset passwords. The same applies to all other
remediation activities aimed at kicking the adversary out, such as
blocking malicious IP addresses, blackholing malicious domains,
quarantining compromised systems, resetting passwords, etc. The most
effective time to execute these activities is when there is a thorough
understanding of the extent of the compromise. This is referred to by
<code>Mandiant</code> as the Strike Zone.</p><p><img src=images/11.png alt></p><p>Striking too soon may result in re-doing the remediation
activities. Striking too late may result in the adversary achieving
their mission. Finding the sweet spot is important, and for me that is
when I don&rsquo;t find any new evidence and when I feel comfortable in
knowing we have enough measures in place to respond effectively when
the adversary comes back.</p><h2 id=sending-alerts>Sending alerts</h2><p>When you want to send an alert the moment a detection took place,
follow the steps below. This enables the server-side artifacts that
monitor for triggered alerts.</p><p>In the below example I used Teams to receive the alerts, but any other
communication platform that supports Webhooks would work.</p><ol><li>Go to Server Events and update the server monitoring table</li></ol><p><img src=images/7.png alt></p><ol start=2><li>Select the artifact ‘Server.Alerts.ProcessCreation’ and/or
<code>Server.Alerts.Trackaccount</code> and go to the next window ‘Configure
Parameters’.</li></ol><p><img src=images/8.png alt></p><ol start=3><li><p>Create a webhook and enter the URL as a parameter. They are easy
to obtain, a quick procedure for Microsoft Teams can be found
<em><a href=https://learn.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/add-incoming-webhook>here</a></em>. Webhooks
for other platforms can also be created, such as for Slack,
Discord, and others.</p></li><li><p>If all works well, you should receive an alert in your
communication platform when an alert is triggered.</p></li></ol><p><img src=images/9.png alt></p><h2 id=creating-an-overview-of-alerts>Creating an overview of alerts</h2><p>Besides sending alerts, it is also handy to create an overview in
Velociraptor with all alerts. With the Notebook capability you can
create this. One requirement is that the server-side artifacts needs
to be created by following the steps in the previous paragraph.</p><p><img src=images/10.png alt></p><p>The VQL query below is what you can enter in a Notebook to create an
overview of the alerts.</p><pre><code class=language-vql>SELECT EventData.UtcTime as UtcTime,
       EventData.CommandLine as CommandLine,
       Hostname, ClientId
FROM source(artifact='Server.Alerts.ProcessCreation')
</code></pre><p>If you want to list the alerts of the artifact
<code>Windows.Events.Trackaccount</code> you need to make some slight changes to
the VQL query, such as changing the artifact name and the selected
fields.</p><h2 id=test-test-test>Test. Test. Test.</h2><p>Always test the detections you put in place. The way I typically test
with Velociraptor is by mimicking the adversary activity on a test
system that is connected to the Velociraptor server. For example, I
launch a command that the adversary used and I check to see if that
results in an alert. Another possibility is launching <a href=https://docs.velociraptor.app/docs/gui/clients/#remote-shell-commands>remote shell
commands</a>
via Velociraptor.</p><h2 id=what-more-can-be-done>What more can be done?</h2><p>The sky is the limit when it comes to detecting the adversary using
Velociraptor. And there are still opportunities for building
artifacts:</p><ul><li>Registry changes (for example when persistence of malware is
created)</li><li>Detect process injection</li><li>Named pipes detection</li></ul><p>Below is a list of artifacts that are already built:</p><ul><li>File changes (<code>Windows.Detection.Usn</code>)</li><li>DNS request monitoring (for clients: <code>Windows.ETW.DNS</code>, and for
servers: <code>Windows.ETW.DNSQueriesServer</code>)</li><li>Service creation (<code>Windows.Events.ServiceCreation</code>)</li><li>PsExec usage (<code>Windows.Detection.PsexecService</code>)</li><li>WMI process creation events (<code>Windows.ETW.WMIProcessCreate</code>)</li></ul><p>If you have any other ideas for detection feel free to share!</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1674224717></script>
<script src=/js/perfect-scrollbar.min.js?1674224717></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1674224717></script>
<script src=/js/jquery.sticky.js?1674224717></script>
<script src=/js/featherlight.min.js?1674224717></script>
<script src=/js/highlight.min.js?1674224717></script>
<script>hljs.highlightAll()</script><script src=/js/modernizr.custom-3.6.0.js?1674224717></script>
<script src=/js/learn.js?1674224717></script>
<script src=/js/hugo-learn.js?1674224717></script></body></html>